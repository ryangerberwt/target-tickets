<script>
    var $ = jQuery;
    var targetErrors = targetErrors || [];
    console.log('OT-1282 | Vignale');

    // Vehicle Info
    var storedData_1282 = {
        id: "${profile.id}",
        market: "${profile.market}",
        ticket: "${profile.ticket}",
        carName: "${profile.carName}",
        date: "${profile.date}",
        emissions: "${profile.emissions}" == "" ? "" : JSON.parse("${profile.emissions}".replace(/'/g, '"')),
        img: "${profile.img}",
        retailPrice: "${profile.retailPrice}",
        retailTitle: "${profile.retailTitle}",
        offerPrice: "${profile.offerPrice}",
        offerTitle: "${profile.offerTitle}",
        subName: "${profile.subName}",
        vehicleType: "${profile.vehicleType}",
        contextualiseLink: "${profile.contextualiseLink}",
        vehicleCode: "${profile.vehicleCode}"
    }

    // Popup Data
    var popupData_1282 = {
        popup_last_closed: Number("${profile.ro.popup_last_closed}"),
        popup_display_count: Number("${profile.ro.popup_display_count}")
    };
    console.log("stored data: ", storedData_1282);

    var v_name = storedData_1282.carName;
    var v_name_arr = v_name.split(" ");

    var re = /^[A-Za-z]+$/;

    if (v_name_arr.length > 1) {
        v_name_arr.forEach((elment, index) => {
            if (!re.test(elment)) {
                var x = v_name_arr.splice(index, 1)
                v_name = v_name_arr.join(" ");
            }
        })
    }

    v_name = v_name_arr.join(" ").replace("Ford", '').trim();

    var isVignale = function () {
        let list = ["fiesta", "edge"];
        let arr = storedData.carName.split(" ");
        let key = arr[arr.length - 1].toLowerCase().trim();

        if (list.includes(key)) {
            return true;
        }

        return false;
    };

    if (v_name == "ECO SPORT") {
        v_name = "EcoSport"
    }

    storedData_1282.carName = "Ford " + v_name;

    // Just in case data from a different Market gets through
    // Also checks if a vehicleCode is available, if it doesn't it won't display.
    var display_1282 = "RO" == storedData_1282.market && "OT-1282" == storedData_1282.ticket && !storedData_1282.vehicleCode.toLowerCase().includes('undefined') && isVignale();

    if (display_1282) {

        if (storedData_1282.contextualiseLink.indexOf('bodystyle') > 0) {
            storedData_1282.contextualiseLink = storedData_1282.contextualiseLink.replace('bodystyle', 'colour');
        } else if (storedData_1282.contextualiseLink.indexOf('colour') > 0) {
            storedData_1282.contextualiseLink = storedData_1282.contextualiseLink.replace('colour', 'interior');
        } else if (storedData_1282.contextualiseLink.indexOf('interior') > 0) {
            storedData_1282.contextualiseLink = storedData_1282.contextualiseLink.replace('interior', 'extras');
        }



        $(document).ready(function () {

            function overrideLog(error) {
                if (/targetDebug=1282/i.test(window.location.href)) {
                    console.log(error);
                }

                targetErrors.push({ ticket: "1282", error });
            }
            /**
            *
            *	DOM builder
            *	(requires jQuery)
            *
            * #def name DOMBuilder
            *
            *	SYNTAX:
            *	jQueryobject DOMbuilder(srcObject);
            *
            *	srcObject = DOMobject || [array of DOMobject] || jQueryObject || [array of jQueryObject] || function (returning srcObject);
            *
            *	DOMobject = {
            *		type: 'div',
            *		id: 'elm-id' || null,
                render: boolean, // You can decide if element will be rendered
            *		className: 'elm-class' || 'elm-class-1 elm-class-2' || null,
            *		data: { key: key, value: value } || null,
            *		text: 'Text content' || null,
            *		html: 'HTML content' || null,		// if html provided, text is ignored
            *		child: srcObject || null
            *		handlers: { eventID: function, ... } || null,
            *		callback: function($element) || null
            *		} || [ array of DOMobj ]
            *
            */
            function DOMBuilder(obj) {
                if (!obj) return;
                if ($.isArray(obj)) {
                    var i, arr = [];
                    for (i = 0; i < obj.length; i++) {
                        (obj[i] instanceof $) ? arr.push(obj[i]) : arr.push(DOMBuilder(obj[i]));
                    }
                    return arr;
                } else if (obj instanceof $) return obj;
                else if ($.isFunction(obj)) return DOMBuilder(obj());
                else {
                    if (!obj.type) return obj.html || obj.text || undefined;
                    if (obj.hasOwnProperty("render") && !obj.render)
                        return undefined;
                    var $e = $('<' + obj.type + '>');
                    if (obj.id) $e.prop('id', obj.id);
                    if (obj.className) $e.addClass(obj.className);
                    if ($.isPlainObject(obj.data) && obj.data.key) $e.data(obj.data.key, obj.data.value);
                    obj.html ? $e.html(obj.html) : $e.text(obj.text || '');
                    if (obj.child) $e.append(DOMBuilder(obj.child));
                    if ($.isPlainObject(obj.handlers)) {
                        for (var evName in obj.handlers) $e.on(evName, obj.handlers[evName]);
                    }
                    if ($.isPlainObject(obj.props)) {
                        for (var propName in obj.props) $e.prop(propName, obj.props[propName]);
                    }
                    if ($.isFunction(obj.callback)) obj.callback($e);
                    return $e;
                }
            }

            /**
            * JS VARIANT "Challenger" - Create testdrive popin or similar approach to generate additional testdrive leads
            */

            var Constructions = {};
            var ENV = {
                elements: {},
                data: {}
            };

            // Configurations
            /* Market configuration */

            $(document).ready(function (environment) {
                environment.MarketConfiguration = {
                    // Define overlay URL
                    overlay: "/overlay/content/overlays/target/tdr",
                    // Define delay in ms before opening overlay
                    delayBeforeOpenOverlay: 10000,

                    // Panel with informations like CO2
                    carDataSelector: "#global-ux .summary-wrapper .vehicle-info-view .vehicle-data .vehicle-data-row",
                    // Selectors to disclaimers in summary page
                    disclaimersSelector: "#global-ux .disclosure-text > ul.disclosure-list",
                    // Selector to offer price (if exists)
                    offerPriceSelector: "#global-ux .vehicle-view-container .vehicle-view-content.left-content .vehicle-view-price .price-promotional-bnp",
                    // Selector to retail price (if exists)
                    retailPriceSelector: "#global-ux .vehicle-view-container .vehicle-view-content.left-content .vehicle-view-price .price-retail-with-otr",

                    // Determine which data will be grabed from summary page
                    summaryPageDataDestinations: [{
                        // Image of car
                        query: "#build-price-configurator > div.app-view > div > div:nth-child(5) > section > div.vehicle-view-container > div.vehicle-view-content.right-content > div > img",
                        prop: "src",
                        key: "img"
                    }, {
                        // Find a dealer link
                        query: "a[data-contextual-link=\"dealer-locator\"]",
                        prop: "href",
                        key: "findDealer"
                    }, {
                        // Car nameplate name
                        query: "#build-price-configurator > div.app-view > div > div:nth-child(5) > section > div.vehicle-view-container > div.vehicle-view-content.left-content > h3 > strong",
                        text: true,
                        key: "carName"
                    }]
                };
            }(ENV));

            var MBOXName = "RO_BP_C_Popin";
            var MBOXFallbackTimeout = 300;

            /* Define texts - easily move across markets */

            function returnSupThree() {
                return "<sup class='supThreeClick'><a style='text-decoration: unset'>3</a></sup>";
            }

            $(document).ready(function (environment) {

                var translations = {
                    heading: "Nu ai reusit sa termini de configurat modelul <nameplate>? Continua, trimite configuratia unui dealer Ford si solicita o oferta personalizata!",
                    pricePrefix: "",
                    priceSuffix: "",
                    dutyFree: "",
                    mainPriceLabel: "",
                    mainPriceLabelNoOfferPrice: "",

                    priceTooltipHeading: "Termeni si conditii",
                    bookTDRButton: "Continua!",

                    retailDisclaimer: "",
                    retailKey: "",
                    retailLabel: "",

                    offerDisclaimer: "",
                    offerKey: "",
                    offerLabel: "",
                };


                environment.Localisation = {
                    formatDate: formatDate,
                    formatMoney: function (amount) {
                        return Number(Number(amount).toFixed(0)).toLocaleString().replace(/\,/gm, ".")
                    },
                    getTranslation: getTranslation,
                    updateTranslations: updateTranslations,
                    requiredLabelsExist: requiredLabelsExist
                };

                function isNull(obj) {
                    return obj == undefined || obj == null || obj == "";
                }

                function requiredLabelsExist() {
                    if (!isNull(storedData_1282.offerPrice))
                        if (isNull(getTranslation("offerLabel")))
                            return false;

                    if (!isNull(storedData_1282.retailPrice))
                        if (isNull(getTranslation("retailLabel")))
                            return false;

                    return true;
                }

                function getTranslation(key, replacements) {
                    var tr = translations[key];
                    if (!tr)
                        return;
                    if (replacements) {
                        $(Object.keys(replacements)).each(function (i, replace) {
                            tr = tr.replace("<" + replace + ">", replacements[replace]);
                        });
                    }

                    overrideLog(key + ": " + tr);
                    return tr;
                }

                function updateTranslations(key, replacements) {
                    try {
                        if (replacements) {
                            translations[key] = replacements;
                        }
                    } catch (e) {
                        // assume key doesn't exist.
                        overrideLog(e);
                    }

                }

                function formatDate(date) {
                    return date.getDate() + "/" + (date.getMonth() + 1) + "/" + date.getFullYear();
                }
            }(ENV));

            var StorageHandler = {};
            StorageHandler.cookie = "opt-gux-ro"; // opt-gux-MARKET ~ for countries with multiple locales, name it MARKET_LANG ~ Always lower case.
            StorageHandler.getData = function () {
                var current = JSON.parse(localStorage.getItem(StorageHandler.cookie));
                if (current == null)
                    return [];
                else
                    return current;
            };
            StorageHandler.saveData = function (key, data) {
                var current = StorageHandler.getData();

                var exists = StorageHandler.getSpecificData(key);

                if (exists.length > 0) {
                    for (var i = 0; i < current.length; i++) {
                        if (current[i].key == key) {
                            current[i].data = data;
                        }
                    }
                } else {
                    current.push({ key, data });
                }
                localStorage.setItem(StorageHandler.cookie, JSON.stringify(current));
            };
            StorageHandler.getSpecificData = function (key) {
                var current = StorageHandler.getData();
                return current.filter(function (each) {
                    return each.key == key;
                });
            };


            // Elements builder
            function loadInfo() {
                ENV.Localisation.updateTranslations("offerLabel", storedData_1282.offerTitle);
                ENV.Localisation.updateTranslations("retailLabel", storedData_1282.retailTitle);
                var key = "disclaimers_1282_" + storedData_1282.id;

                var data = StorageHandler.getSpecificData(key);

                if (data.length == 0) {
                    return;
                }

                var disclaimerObj = data[0].data;

                for (var i = 0; i < disclaimerObj.length; i++) {
                    if (disclaimerObj[i].type == "Retail") {
                        ENV.Localisation.updateTranslations("retailDisclaimer", disclaimerObj[i].content);
                        ENV.Localisation.updateTranslations("retailKey", disclaimerObj[i].symbol);
                    } else if (disclaimerObj[i].type == "Offer") {
                        ENV.Localisation.updateTranslations("offerDisclaimer", disclaimerObj[i].content);
                        ENV.Localisation.updateTranslations("offerKey", disclaimerObj[i].symbol);
                    }
                }
            }
            loadInfo();


            /* Generate tooltip */
            $(document).ready(function () {

                var tooltipInstance;
                var overlay;

                function docGlobUXOnClick(event) {
                    if (event.target.id === "optprg-tdr-pop-up-price-tooltip" || $(event.target).parents("#optprg-tdr-pop-up-price-tooltip").length)
                        return;
                    event.preventDefault();
                    closeTooltip();
                }
                function onResizeOrScrollEvent() {
                    closeTooltip();
                }
                function closeTooltip(event) {
                    if (event)
                        event.preventDefault();
                    if (!tooltipInstance)
                        return;
                    overlay.unbind("mousedown", docGlobUXOnClick);
                    overlay.unbind("scroll", onResizeOrScrollEvent);
                    $(window).unbind("resize", onResizeOrScrollEvent);
                    tooltipInstance.remove();
                    tooltipInstance = undefined;
                }
                function tooltip(options, close) {
                    return DOMBuilder({
                        type: "div",
                        className: "gux-tooltip-overlay",
                        id: "optprg-tdr-pop-up-price-tooltip",
                        props: {
                            tabindex: "0"
                        },
                        callback: function (element) {
                            element.attr("style", "position: absolute; top: " + options.top + "px; left: " + options.left + "px;right: auto; bottom: " + (options.bottom == undefined ? "auto" : options.bottom + "px") + "; z-index: 10001;");
                        },
                        child: [{
                            type: "h5",
                            className: "gux-tooltip-overlay-title",
                            text: options.title
                        }, {
                            type: "span",
                            className: "gux-tooltip-overlay-text",
                            child: [{
                                type: "span",
                                render: options.number ? true : false,
                                text: options.number
                            }, {
                                type: "p",
                                html: options.text
                            }]
                        }, {
                            type: "a",
                            className: "close-icon",
                            handlers: {
                                click: close
                            },
                            props: {
                                tabindex: "0"
                            }
                        }]
                    });
                }
                Constructions.openTooltip = function (options) {
                    closeTooltip();

                    tooltipInstance = tooltip(options, closeTooltip);
                    $("#global-ux").append(tooltipInstance);
                    if (!overlay)
                        overlay = options.overlay.parent();
                    overlay.on("mousedown", docGlobUXOnClick);
                    overlay.on("scroll", onResizeOrScrollEvent);
                    $(window).on("resize", onResizeOrScrollEvent);
                };
            }());

            /* Component for show easily price - !this file has connection to tooltip definition */

            Constructions.getPrice = function (options) {
                return DOMBuilder({
                    type: "span",
                    child: [{
                        type: "span",
                        className: "vehicle-attribute-group price-finalPrice-grossRetailWithOTRAndIncentives",
                        child: [{
                            type: "p",
                            className: "optprg-carname",
                            text: options.carName,
                            child: [{
                                type: "span",
                                className: "optprg-subname",
                                //text: options.subName
                                html: options.subName
                            }]
                        },
                        {
                            type: "p",
                            className: "optprg-main-price-label",
                            text: options.recPrice,
                            id: "id-optprg-main-price-label"
                        }, {
                            type: "span",
                            className: "optprg-vehicle-attribute-prefix",
                            text: ENV.Localisation.getTranslation(options.pricePrefixName)
                        }, {
                            type: "span",
                            className: "value optprg-main-price-value",
                            text: options.price
                        }, {
                            type: "span",
                            className: "duty-free",
                            text: options.dutyPrice
                        }, {
                            type: "span",
                            className: "optprg-vehicle-attribute-suffix",
                            text: ENV.Localisation.getTranslation(options.priceSuffixName)
                        }
                        ]
                    }, {
                        type: "sup",
                        className: "optprg-sup",
                        render: options.text ? true : false,
                        props: {
                            href: "#"
                        },
                        child: [{
                            type: "a",
                            className: "optprg-a",
                            text: options.number,
                            handlers: {
                                click: function (e) {
                                    e.preventDefault();
                                    var position = $(this).offset();
                                    var size = {
                                        w: $(this).width(),
                                        h: $(this).height()
                                    };
                                    Constructions.openTooltip({
                                        top: position.top + size.h,
                                        left: position.left + size.w,
                                        title: options.heading,
                                        text: options.text,
                                        number: options.number,
                                        overlay: options.overlay
                                    });
                                }
                            }
                        }]
                    }]
                });
            };


            // Handlers
            /* Handle close events */

            function initializeCloseHandlers(overlay) {
                function destroy() {
                    $(document).unbind("keydown", onKeyPress);
                    destroyOverlay();
                }
                function destroyOverlay() {
                    var content = $('.optprg-tdr-pop-up-1282-content'); // Replace 1041 to match the ticket you're on.
                    if (content.length > 0) {
                        var contentParent = content[0].parentElement;
                        if (!isNull(contentParent) && contentParent.classList.value.includes('overlay-container')) {
                            contentParent.remove();
                        }
                    }
                }
                var handlers = {
                    dontShowAgainClose: function (wayOfDestroy, callback, mbox) {
                        adobe.target.trackEvent({
                            mbox: mbox,
                            params: {
                                release: wayOfDestroy,
                                popup: wayOfDestroy
                            },
                            success: function () {
                                if (callback)
                                    callback();
                            },
                            error: function () {
                                if (callback)
                                    callback();
                            }
                        });
                        if (callback)
                            setTimeout(function () {
                                callback();
                            }, MBOXFallbackTimeout);
                        destroy();
                    },
                    showAgainClose: function (wayOfDestroy, mbox) {
                        adobe.target.trackEvent({
                            mbox: mbox,
                            params: {
                                popup: wayOfDestroy
                            }
                        });
                        destroy();
                    }
                };
                function onKeyPress(e) {
                    if (e.keyCode == 27) {
                        handlers.dontShowAgainClose("close_escape_keyboard", Popup.setLastClosed(), "RO_1282_close_cta_ctr");
                    }
                }
                $(document).on("keydown", onKeyPress);
                overlay.find("span.overlay-close").on("click", function (e) {
                    handlers.dontShowAgainClose("clicked_x", Popup.setLastClosed(), "RO_1282_close_cta_ctr");
                });
                overlay.parent(".overlay-container").on("click", function (e) {
                    if ($(e.target).hasClass("overlay-container"))
                        handlers.showAgainClose("clicked_outside_overlay", Popup.setLastClosed(), "RO_1282_close_cta_ctr");
                });
                return handlers;
            }

            function updatepopupData_1282(popup_last_closed, popup_display_count) {
                adobe.target.getOffer({
                    'mbox': 'global-mbox',
                    'params': {
                        'profile.ro.popup_last_closed': popup_last_closed,
                        'profile.ro.popup_display_count': popup_display_count
                    },
                    'success': function (offer) {
                        adobe.target.applyOffer({
                            'mbox': 'global-mbox',
                            'offer': offer
                        });
                    },
                    'error': function (status, error) {
                        console.log('Error', status, error);
                    }
                });
            }

            var Popup = {};
            Popup.isPopupOpen = false;
            Popup.showPopupAfter = 900; // IN SECONDS - 900 SECONDS WHICH IS 15 MINUTES
            Popup.openThreshold = 2; // LIMIT THE AMOUNT OF TIMES THE POPUP OPENS
            Popup.currentTimeStamp = Math.floor(Date.now() / 1000);
            Popup.setLastClosed = function () {
                Popup.setKeyValue("popup_last_closed", Math.floor(Date.now() / 1000));
            };
            Popup.determineIfPopupShows = function () {

                if (!ENV.Localisation.requiredLabelsExist()) {
                    overrideLog("Price labels, not populated");
                    return false;
                }

                var popupCookie = popupData_1282;
                var timeBool = false;
                var limitBool = false;

                // --------------------------------------------------------
                // DETERMINE IF 15 DAYS HAS PASSED SINCE LAST POPUP CLOSED
                // --------------------------------------------------------
                var lastClosed_minutes = Math.floor(popupCookie.popup_last_closed / 60);
                var current_minutes = Math.floor(Popup.currentTimeStamp / 60);
                var minuteDifference = current_minutes - lastClosed_minutes;

                if (minuteDifference >= 21600) {
                    popupData_1282.popup_last_closed = 0;
                    popupData_1282.popup_display_count = 1;
                    updatepopupData_1282(popupData_1282.popup_last_closed, popupData_1282.popup_display_count);

                    return true; // In order for popup to appear
                }
                // ---------------------------------------------
                var lastClosed_minutes = Math.floor(popupCookie.popup_last_closed / 60);
                var current_minutes = Math.floor(Popup.currentTimeStamp / 60);
                var minuteDifference = current_minutes - lastClosed_minutes;

                if (minuteDifference >= 21600) {
                    popupData_1282.popup_last_closed = 0;
                    popupData_1282.popup_display_count = 1;
                    updatepopupData_1282(popupData_1282.popup_last_closed, popupData_1282.popup_display_count);

                    return true; // In order for popup to appear
                }

                // ---------------------------------------------
                // DETERMINE IF 15 MINUTE TIME LIMIT HAS EXPIRED
                // ---------------------------------------------
                var timeDifference = Popup.currentTimeStamp - popupCookie.popup_last_closed;

                if (timeDifference > Popup.showPopupAfter) {
                    timeBool = true;
                }
                else {
                    overrideLog("SHOW AFTER FAILED");
                    overrideLog("TIME DIFFERENCE: " + timeDifference + "/" + Popup.showPopupAfter);
                }

                // ---------------------------------------------
                // LIMIT OPEN THRESHOLD
                // ---------------------------------------------
                if (popupCookie.popup_display_count <= Popup.openThreshold && timeBool === true) {

                    if (popupCookie.popup_last_closed != null) {
                        // INCREASE OPEN COUNTER BY 1
                        Popup.setKeyValue("popup_display_count", ++popupCookie.popup_display_count);
                        Popup.setLastClosed();
                    }

                    limitBool = true;
                }
                overrideLog("TIMEBOOL : " + timeBool);
                overrideLog("LIMITBOOL: " + limitBool);
                //return true;
                return (timeBool && limitBool) || /targetDebug=1282/i.test(window.location.href);
            };
            Popup.setKeyValue = function (key, value) {

                popupData_1282[key] = value;

                updatepopupData_1282(popupData_1282.popup_last_closed, popupData_1282.popup_display_count)
            };

            /* Open TDR Overlay */
            var OverlayHelpers = {};

            $(document).ready(function () {

                var isAlreadyOpenCalled = false;

                OverlayHelpers.openOverlay = function (overlay, onOverlayOpen) {
                    if (isAlreadyOpenCalled)
                        return false;

                    isAlreadyOpenCalled = true;
                    var element = $("<a href=\"" + overlay + "\" style=\"display: none;\" class='test-me'></a>");
                    $("body").append(element);

                    function waitForOverlayOpen(overlay) {
                        if (!overlay.$overlayContent)
                            return setTimeout(function () {
                                waitForOverlayOpen(overlay);
                            }, 50);
                        onOverlayOpen(overlay);
                    }


                    /*require(['overlay/component.overlay'],*/

                    element.on('click', function (e) {
                        e.preventDefault();
                    });

                    try {
                        var Checking_GuxOverlay_1282 = guxOverlay;
                    } catch (ex) {
                        console.log("New solution required");
                        overrideLog(ex);
                        return false;
                    }


                    if (!popupData_1282) {

                        updatepopupData_1282(0, 1);
                        Popup.setLastClosed();

                        var overlay = guxOverlay.default.init(element);
                        overrideLog("Trigger Popup");
                        overlay.getOverlayContent('/overlay/content/overlays/target/tdr');
                        waitForOverlayOpen(overlay);
                        Popup.isPopupOpen = true;
                    }
                    else {
                        if (Popup.determineIfPopupShows()) {
                            var overlay = guxOverlay.default.init(element);
                            overrideLog("Trigger Popup");
                            overlay.getOverlayContent('/overlay/content/overlays/target/tdr');
                            waitForOverlayOpen(overlay);
                        }
                    }
                    element.remove();
                };

                /* Fill overlay with data */
                OverlayHelpers.fillOverlay = function (overlay, data, closeHandlers, limit) {
                    ENV.overlayInstance = overlay;
                    var overlayContent = overlay.$overlayContent;
                    var image = overlayContent.find("img.picture-tag-fallback");

                    if (limit >= 100)
                        return false;

                    if (!image.length)
                        return setTimeout(function () {
                            OverlayHelpers.fillOverlay(overlay, data, closeHandlers, limit ? limit++ : 1);
                        }, 40);

                    locateAllElements(overlayContent, image, data.offerPrice ? true : false);
                    fillFinishedBnPOverlay(data, closeHandlers);

                };

                function locateAllElements(overlayContent, image, hasOfferPrice) {
                    ENV.elements.overlayContent = overlayContent.addClass("optprg-tdr-pop-up-1282-content");

                    ENV.elements.image = image.addClass("optprg-tdr-pop-up-image");
                    ENV.elements.heading = overlayContent.find("h3").addClass("optprg-tdr-pop-up-heading");
                    ENV.elements.offerPrice = overlayContent.find("h4").addClass("optprg-tdr-pop-up-price");

                    var clonedPrice = ENV.elements.offerPrice.clone();
                    //clonedPrice[0].outerHTML = clonedPrice[0].outerHTML.replaceAll("h4", "h5");

                    ENV.elements.retailPrice = ENV.elements.offerPrice.after(clonedPrice).next();
                    ENV.elements.retailPrice[0].outerHTML = ENV.elements.retailPrice[0].outerHTML.replaceAll('h4', 'h5');
                    ENV.elements.retailPrice = overlayContent.find("h5");

                    var multiple_h5 = overlayContent.find("h5");
                    console.log("multiple h5 ", multiple_h5);
                    if (multiple_h5.length > 1) {
                        multiple_h5[0].remove()
                    }
                    //test
                    ENV.elements.afterPrices = ENV.elements.retailPrice.next("p");
                    ENV.elements.secondatyButton = overlayContent.find("a.cta-button.cta-button-secondary");
                    ENV.elements.primaryButton = overlayContent.find("a.cta-button.cta-button-primary");
                    ENV.elements.horsTaxe = ENV.elements.retailPrice.after(DOMBuilder({
                        type: "p",
                        className: "hors-taxe"
                    })).next();

                    ENV.elements.priceInformation = ENV.elements.primaryButton.after(DOMBuilder({
                        type: "p",
                        className: "optprg-co2-info"
                    })).next();
                    ENV.elements.co2Information = ENV.elements.priceInformation.after(DOMBuilder({
                        type: "p",
                        className: "optprg-price-info"
                    })).next();
                }

                function fillFinishedBnPOverlay(data, closeHandlers) {

                    try {
                        var i = 0;
                        ENV.elements.heading.html(ENV.Localisation.getTranslation("heading").replace("<nameplate>", data.carName + ' ' + data.subName));
                        //var priceInfo = ENV.Localisation.getTranslation("priceValidText");
                        ENV.elements.priceInformation.text(ENV.Localisation.getTranslation("priceValidText"));

                        // MachE being the only vehicle with a visible price.

                        if (!data.offerPrice || !storedData_1282.offerTitle)
                            ENV.elements.offerPrice.hide();
                        else {
                            ENV.elements.offerPrice.html(Constructions.getPrice({
                                pricePrefixName: "pricePrefix",
                                priceSuffixName: "priceSuffix",
                                carName: data.carName,
                                subName: " " + data.subName,
                                price: ENV.Localisation.formatMoney(data.offerPrice) + "€",
                                //price: "Prix remisé: " + ENV.Localisation.formatMoney(data.offerPrice),
                                //text: ENV.Localisation.getTranslation("disclaimer1"),
                                //number: "*",
                                recPrice: ENV.Localisation.getTranslation("offerLabel"),//PRIX TOTAL REMISÉ", 
                                text: ENV.Localisation.getTranslation("offerDisclaimer"),
                                number: ENV.Localisation.getTranslation("offerKey"),
                                heading: ENV.Localisation.getTranslation("priceTooltipHeading"),
                                overlay: ENV.elements.overlayContent
                            }));
                        }

                        if (!data.retailPrice)
                            ENV.elements.retailPrice.hide();
                        else {
                            ENV.elements.retailPrice.attr("class", "optprg-retail-price-box " + (data.offerPrice ? "optprg-include-offer" : "optprg-not-include-offer")).html(Constructions.getPrice({
                                pricePrefixName: "pricePrefix",
                                priceSuffixName: "priceSuffix",
                                carName: !data.offerPrice ? data.carName + " " : "",
                                subName: !data.offerPrice ? data.subName : "",
                                //price: (data.retailPrice ? "Prix: " : "") + ENV.Localisation.formatMoney(data.retailPrice),
                                price: ENV.Localisation.formatMoney(data.retailPrice) + " €",
                                //text: ENV.Localisation.getTranslation("disclaimer2"),
                                //number: "**",
                                recPrice: ENV.Localisation.getTranslation("retailLabel"),
                                text: ENV.Localisation.getTranslation("retailDisclaimer"),
                                number: ENV.Localisation.getTranslation("retailKey"),
                                heading: ENV.Localisation.getTranslation("priceTooltipHeading"),
                                overlay: ENV.elements.overlayContent
                            }));
                        }


                        overrideLog('not commercial vehicle');
                        $('.duty-free').hide();
                        /*$('.optprg-main-price-label').hide();*/

                        overrideLog(data.tdr);
                        overrideLog(data.tdrVehicleCode);

                        ENV.elements.overlayContent.find("source").attr("srcset", data.img);
                        ENV.elements.image.removeAttr("src").attr("src", data.img).attr("alt", data.carName).attr("title", data.carName);
                        ENV.elements.secondatyButton.remove();
                        ENV.elements.primaryButton
                            .attr("href", storedData_1282.contextualiseLink)
                            .text(ENV.Localisation.getTranslation("bookTDRButton"))
                            .removeAttr("data-cta-name")
                            .addClass('optprg-primary-button')
                            .on("click", function () {

                                closeHandlers.dontShowAgainClose("clicked_TDR_CTA", function () {

                                    adobe.target.trackEvent({
                                        "mbox": MBOXName,
                                        "params": {
                                            "linkClicked": "true"
                                        }
                                    });

                                    _satellite.track("impression-xt-popin")

                                    ENV.overlayInstance.hideOverlay();
                                }, "RO_1282_main_cta_ctr");
                            });

                        ENV.elements.afterPrices.hide();
                        var emissions = data.emissions.co ? getValueUnit(data.emissions.co) : { unit: "", value: "" };
                        var litersToUnit = data.emissions.lToKm ? getValueUnit(data.emissions.lToKm) : { unit: "", value: "" };
                        var hybridInfo = data.emissions.kwToKm ? getValueUnit(data.emissions.kwToKm) : { unit: "", value: "" };


                        litersToUnit.unit = litersToUnit.unit.toLowerCase();
                        litersToUnit.value = litersToUnit.value.replace('.', ',');
                        emissions.value = emissions.value.replace('.', ',');
                        hybridInfo.value = hybridInfo.value == "" ? "" : (
                            hybridInfo.value < 100 ? hybridInfo.value.replace('.', ',') : (
                                ((hybridInfo.value / 10) + "").replace('.', ',')
                            )
                        )

                        var line_fuelConsumption = litersToUnit.value != "" ? ENV.Localisation.getTranslation("fuelConsumption", {
                            ltValue: litersToUnit.value,
                            ltUnit: litersToUnit.unit
                        }) : "",
                            line_co2Information = emissions.value != "" ? ENV.Localisation.getTranslation("co2Information", {
                                coValue: emissions.value,
                                coUnit: emissions.unit
                            }) : "",
                            line_electricConsumption = hybridInfo.value != "" ? ENV.Localisation.getTranslation("electricConsumption", {
                                kwValue: hybridInfo.value
                            }) : "";

                        if (line_fuelConsumption || line_co2Information || line_electricConsumption) {
                            ENV.elements.co2Information.html(
                                line_fuelConsumption + line_electricConsumption + line_co2Information
                            );

                            var overlayForSup = $('.optprg-tdr-pop-up-1282-content');
                            var sups = overlayForSup.find('.supThreeClick');

                            var title = ENV.Localisation.getTranslation('priceTooltipHeading');
                            var text = ENV.Localisation.getTranslation('disclaimer3');

                            for (var i = 0; i < sups.length; i++) {
                                sups[i].onclick = function (e) {
                                    try {
                                        e.preventDefault();
                                        var position = $(this).offset();
                                        var size = {
                                            w: $(this).width(),
                                            h: $(this).height()
                                        };
                                        Constructions.openTooltip({
                                            top: position.top + size.h,
                                            left: position.left + size.w,
                                            bottom: 0,
                                            title: title,
                                            text: text,
                                            number: '3',
                                            overlay: overlayForSup
                                        });
                                    } catch (E) {
                                        overrideLog(E);
                                    }
                                }
                            }
                        } else {
                            overrideLog('hidden emissions');
                            ENV.elements.co2Information.hide();
                        }



                    } catch (ex) {
                        overrideLog(ex);
                    }
                }
                function getValueUnit(map) {
                    if (map.value != undefined)
                        return map;
                    var units = Object.keys(map);
                    if (!units.length)
                        return null;
                    return {
                        unit: map[units[0]].unit,
                        value: map[units[0]].value
                    };
                }
            }());

            if (!display_1282 || !storedData_1282.img || !storedData_1282.carName || storedData_1282.contextualiseLink == window.location.pathname)
                return;

            var Popupdetection = {};
            Popupdetection.getCookie = function (name) {
                var cookie = " " + document.cookie;
                var search = " " + name + "=";
                var setStr = null;
                var offset = 0;
                var end = 0;
                if (cookie.length > 0) {
                    offset = cookie.indexOf(search);
                    if (offset != -1) {
                        offset += search.length;
                        end = cookie.indexOf(";", offset)
                        if (end == -1) {
                            end = cookie.length;
                        }
                        setStr = unescape(cookie.substring(offset, end));
                    }
                }
                return (setStr);
            };

            function containsSophus() {
                if (typeof s3_creativeDisplayed === "undefined" && (typeof s3_creativeDisplayed !== "object" || !s3_creativeDisplayed))
                    return false;
                if (s3_creativeDisplayed)
                    return true;
                return false;
            }


            function getCookieNameContains(nameIncludes) {
                var allCookies = document.cookie;
                if (allCookies.length > 0) {
                    var cookieArray = allCookies.split(';');
                    for (var i = 0; i < cookieArray.length; i++) {
                        var name = cookieArray[i].split('=')[0];
                        if (name.includes(nameIncludes))
                            return true;
                    }
                }
                return false;
            }

            function blockPopup() {
                if (Popupdetection.getCookie("psyma_participation") === "1" && Popupdetection.getCookie("optprg-popups-disable")) {

                    if ($("#psyma_layer").length > 0) {
                        console.log('blocked');
                        return true;
                    }
                }

                if ((getCookieNameContains('IPE') || getCookieNameContains('IPE_M_')) || containsSophus()) {
                    console.log('blocked');
                    return true;
                }

                return false;
            }

            if (blockPopup())
                return;

            loadInfo();
            function swapPrices() {
                let offerLabelHtml = $('p:contains("Pret promotional")');
                let retailLabelHtml = $('p:contains("Pret total recomandat")');
                let offerPriceHtml = $('.value.optprg-main-price-value:eq(0)')
                let retailPriceHtml = $('.value.optprg-main-price-value:eq(1)');
                let offerDisc = $('.optprg-sup:eq(0)');
                let retailDisc = $('.optprg-sup:eq(1)');

                console.log('lbls and prices');
                console.log(retailLabelHtml.html());
                console.log(offerLabelHtml.html());
                console.log(offerPriceHtml.html());
                console.log(retailPriceHtml.html());


                if (offerLabelHtml.html() !== undefined && offerPriceHtml.html() !== undefined && retailPriceHtml.html() !== undefined && retailLabelHtml.html() !== undefined && offerDisc.html() !== undefined && retailDisc.html() !== undefined) {

                    let oldOfferLbl = offerLabelHtml.html().toString();
                    let oldRetailLbl = retailLabelHtml.html().toString();
                    let oldOfferPrice = offerPriceHtml.html().toString();
                    let oldRetailPrice = retailPriceHtml.html().toString();

                    //Labels
                    retailLabelHtml.html(offerLabelHtml.html());
                    offerLabelHtml.html(oldRetailLbl);

                    //Prices
                    retailPriceHtml.html(offerPriceHtml.html());
                    offerPriceHtml.html(oldRetailPrice);

                    //Class Overrides
                    $('.value.optprg-main-price-value:eq(0)').addClass('firstPriceMobile');
                    $('.value.optprg-main-price-value:eq(1)').addClass('secondPriceMobile');

                    $('.vehicle-attribute-group.price-finalPrice-grossRetailWithOTRAndIncentives>#id-optprg-main-price-label:eq(1)').css('font-size','1.25rem');


                    //Disclaimers
                    $('.optprg-sup').css('display', 'inline-flex');
                    $('.optprg-sup:eq(0)').css('top', '65px').css('font-size', '1.2rem').css('padding-left', '10px').addClass('sup0-mobile');
                    $('.optprg-sup:eq(1)').css('top', '-78px').css('margin-left', '15px').addClass('sup1-mobile');

                    clearInterval(myinterval)

                }
            }
            setTimeout(function () {

                if (!blockPopup()) {
                    OverlayHelpers.openOverlay(ENV.MarketConfiguration.overlay, function (overlay) {

                        OverlayHelpers.fillOverlay(overlay, storedData_1282, initializeCloseHandlers(overlay.$overlayContent));

                        adobe.target.trackEvent({
                            "mbox": MBOXName,
                            "params": {
                                "open": "pop-up-open"
                            }
                        });

                        window.targetCampaign = window.targetCampaign || {
                            page: {
                                campaignName: "tt:nwp:opt-1282:xt:ase:ngc-bpa-bpc"
                            }
                        }
                        _satellite.track("impression-xt-popin")
                    });

                    myinterval = setInterval(swapPrices, 300);
                }
            }, ENV.MarketConfiguration.delayBeforeOpenOverlay);

        }());

        $(window).load(function () {
            var objToHide = document.querySelectorAll('.optprg-carname')[1];
            if (objToHide != undefined) {
                objToHide.style.display = 'none';
            }
        });
    }
</script>
<style>

    
.secondPriceMobile{
        font-size: 1.5rem !important;
    }
    .optprg-tdr-pop-up-price {
        padding: 30px 100px 30px 0px !important;
    }

    @media only screen and (max-width: 760px) {

        .sup0-mobile {
            top: 58px !important;
            padding-left: 0px !important;
        }

        .sup1-mobile {
            top: -67px !important;
            padding-left: 35px !important
        }

        .firstPriceMobile {
            font-size: 1.312rem !important;
        }

        .secondPriceMobile {
            font-size: 1rem !important
        }
    }
</style>