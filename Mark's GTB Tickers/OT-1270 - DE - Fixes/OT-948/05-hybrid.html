<script>
    var targetErrors = targetErrors || [];
    try {
    console.log('OT-948');

    // Vehicle Info
    var storedData_948 = {
        market: "${profile.market}",
        ticket: "${profile.ticket}",
        carName: "${profile.carName}",
        date: "${profile.date}",
        emissions: "${profile.emissions}" == "" ? "" : JSON.parse("${profile.emissions}".replace(/'/g, '"')),
        img: "${profile.img}",
        retailPrice: "${profile.retailPrice}",
        offerPrice: "${profile.offerPrice}",
        subName: "${profile.subName}",
        vehicleType: "${profile.vehicleType}",
        contextualiseLink: "${profile.contextualiseLink}"
    }

    // Popup Data
    var popupData_948 = {
        popup_last_closed: Number("${profile.de.popup_last_closed}"),
        popup_display_count: Number("${profile.de.popup_display_count}")
    };

    // Just in case data from a different Market gets through
    // Also checks if a vehicleCode is available, if it doesn't it won't display.
    var display_948 = "DE" == storedData_948.market && "OT-948" == storedData_948.ticket && !storedData_948.contextualiseLink.toLowerCase().includes('undefined');

    var hybrid = [
        "Ford Fiesta",
        "Ford Puma",
        "Ford Focus",
        "Der Neue Ford Kuga",
        "Der Neue Ford Mustang Mach-E",
        "Ford Mondeo",
        "Ford Explorer Plug-In-Hybrid",
        "Ford Tourneo Custom"
    ];

    if (display_948) {
        display_948 = hybrid.includes("Der Neue " + storedData_948.carName) || hybrid.includes("Der Neue " + storedData_948.carName + " " + storedData_948.subName) || hybrid.includes(storedData_948.carName) || hybrid.includes(storedData_948.carName + " " + storedData_948.subName);
    }

    if (display_948) {

if (storedData_948.contextualiseLink.indexOf('bodystyle') > 0) {
storedData_948.contextualiseLink = storedData_948.contextualiseLink.replace('bodystyle', 'colour');
} else if (storedData_948.contextualiseLink.indexOf('colour') > 0) {
    storedData_948.contextualiseLink = storedData_948.contextualiseLink.replace('colour', 'interior');
} else if (storedData_948.contextualiseLink.indexOf('interior') > 0) {
    storedData_948.contextualiseLink = storedData_948.contextualiseLink.replace('interior', 'extras');
}

$(function() {
    window.targetCampaign = window.targetCampaign || {
        page: {
            campaignName: "tt:nwp:opt-948:xt:ase:ebpa-popin-3"
        }
    }
    _satellite.track("genericTestingImpressionIDWorkaround");
});

(function () {

    function overrideLog(error) {
            if (/targetDebug=948/i.test(window.location.href)) {
                console.log(error);
            }
            
            targetErrors.push({ticket: "948", error});
        }
    /**
    *
    *	DOM builder
    *	(requires jQuery)
    *
    * #def name DOMBuilder
    *
    *	SYNTAX:
    *	jQueryobject DOMbuilder(srcObject);
    *
    *	srcObject = DOMobject || [array of DOMobject] || jQueryObject || [array of jQueryObject] || function (returning srcObject);
    *
    *	DOMobject = {
    *		type: 'div',
    *		id: 'elm-id' || null,
        render: boolean, // You can decide if element will be rendered
    *		className: 'elm-class' || 'elm-class-1 elm-class-2' || null,
    *		data: { key: key, value: value } || null,
    *		text: 'Text content' || null,
    *		html: 'HTML content' || null,		// if html provided, text is ignored
    *		child: srcObject || null
    *		handlers: { eventID: function, ... } || null,
    *		callback: function($element) || null
    *		} || [ array of DOMobj ]
    *
    */
    function DOMBuilder(obj) {
        if (!obj) return;
        if ($.isArray(obj)) {
            var i, arr = [];
            for (i = 0; i < obj.length; i++) {
                (obj[i] instanceof $) ? arr.push(obj[i]): arr.push(DOMBuilder(obj[i]));
            }
            return arr;
        } else if (obj instanceof $) return obj;
        else if ($.isFunction(obj)) return DOMBuilder(obj());
        else {
            if (!obj.type) return obj.html || obj.text || undefined;
            if (obj.hasOwnProperty("render") && !obj.render)
                return undefined;
            var $e = $('<' + obj.type + '>');
            if (obj.id) $e.prop('id', obj.id);
            if (obj.className) $e.addClass(obj.className);
            if ($.isPlainObject(obj.data) && obj.data.key) $e.data(obj.data.key, obj.data.value);
            obj.html ? $e.html(obj.html) : $e.text(obj.text || '');
            if (obj.child) $e.append(DOMBuilder(obj.child));
            if ($.isPlainObject(obj.handlers)) {
                for (var evName in obj.handlers) $e.on(evName, obj.handlers[evName]);
            }
            if ($.isPlainObject(obj.props)) {
                for (var propName in obj.props) $e.prop(propName, obj.props[propName]);
            }
            if ($.isFunction(obj.callback)) obj.callback($e);
            return $e;
        }
    }

    /**
    * JS VARIANT "Challenger" - Create testdrive popin or similar approach to generate additional testdrive leads
    */

    FordPersonalisation.guxFrameworkDeferred.then(function () {
        var Constructions = {};
        var ENV = {
            elements: {},
            data: {}
        };

        // Configurations
        /* Market configuration */

        (function (environment) {
            environment.MarketConfiguration = {
                // Define overlay URL
                overlay: "/overlay/content/overlays/target/tdr",
                // Define delay in ms before opening overlay
                delayBeforeOpenOverlay: 15000,

                // Panel with informations like CO2
                carDataSelector: "#global-ux .summary-wrapper .vehicle-info-view .vehicle-data .vehicle-data-row",
                // Selectors to disclaimers in summary page
                disclaimersSelector: "#global-ux .disclosure-text > ul.disclosure-list",
                // Selector to offer price (if exists)
                offerPriceSelector: "#global-ux .vehicle-view-container .vehicle-view-content.left-content .vehicle-view-price .price-promotional-bnp",
                // Selector to retail price (if exists)
                retailPriceSelector: "#global-ux .vehicle-view-container .vehicle-view-content.left-content .vehicle-view-price .price-retail-with-otr",

                // Determine which data will be grabed from summary page
                summaryPageDataDestinations: [{
                    // Image of car
                    query: "#build-price-configurator > div.app-view > div > div:nth-child(5) > section > div.vehicle-view-container > div.vehicle-view-content.right-content > div > img",
                    prop: "src",
                    key: "img"
                }, {
                    // Find a dealer link
                    query: "a[data-contextual-link=\"dealer-locator\"]",
                    prop: "href",
                    key: "findDealer"
                }, {
                    // Car nameplate name
                    query: "#build-price-configurator > div.app-view > div > div:nth-child(5) > section > div.vehicle-view-container > div.vehicle-view-content.left-content > h3 > strong",
                    text: true,
                    key: "carName"
                }]
            };
        }(ENV));

        var MBOXName = "DE_BP_A_Popin";
        var MBOXFallbackTimeout = 300;

        /* Define texts - easily move across markets */

        function returnSupThree() {
            return "<sup class='supThreeClick'><a style='text-decoration: unset'>3</a></sup>";
        }

        (function (environment) {

            var translations = {
                        heading: "Sie haben Ihre <nameplate> Konfiguration noch nicht beendet.",
                        offerPricePrefix: "€",
                        offerPriceSuffix: "",
                        dutyFree: "Horse Tax", // duty free - commercial vehicles
                        priceValidText: "Preise entsprechen dem Zeitpunkt der letzten Konfiguration.", // Legal Disclaimer
                        fuelConsumption: "Kraftstoffverbrauch: <ltValue> <ltUnit> (kombiniert)" + returnSupThree() + "; ",
                        electricConsumption: "stromverbrauch: <kwValue> kWh/100 km (kombiniert)" + returnSupThree() + "; ",
                        co2Information: "CO<sub>2</sub>-Emissionen: <coValue> <coUnit> (kombiniert)" + returnSupThree(),
                        mainPriceLabel: "Unverbindliche Aktionspreisempfehlung",
                        mainPriceLabelNoOfferPrice: "UPE",

                        retailPricePrefix: "€",
                        retailPriceSuffix: "",

                        priceTooltipHeading: "Rechtliche Hinweise",
                        bookTDRButton: "Jetzt Konfiguration abschließen!",

                        disclaimer1: "Beispielfoto eines Fahrzeuges der Baureihe. Die Ausstattungsmerkmale des abgebildeten Fahrzeuges sind nicht Bestandteil des Angebotes. Unverbindliche Preisempfehlung der Ford-Werke GmbH zzgl. Überführungs- und Zulassungskosten. Aufgrund der voraussichtlichen Auslieferung des Ford Mustang Mach-E ab Anfang 2021 werden die ab dem 01.01.2021 gültigen Preise inklusive 19% Mehrwertsteuersatz gezeigt.",
                        disclaimer2: "Beispielfoto eines Fahrzeuges der Baureihe. Die Ausstattungsmerkmale des abgebildeten Fahrzeuges sind nicht Bestandteil des Angebotes. Unverbindliche Aktionspreisempfehlung der Ford-Werke GmbH zzgl. Überführungs- und Zulassungskosten für Privatkunden bei allen teilnehmenden Ford Partnern. Kombinierbar mit allen Finanzierungsangeboten der Ford Bank GmbH für Privatkunden. Details bei allen teilnehmenden Ford Partnern.",
                        disclaimer3: "",
                    };

            environment.Localisation = {
                formatDate: formatDate,
                formatMoney: function (amount) {
                    return Number(Number(amount).toFixed(0)).toLocaleString().replace(/\,/gm, ".")
                },
                getTranslation: getTranslation,
                updateTranslations: updateTranslations
            };

            function getTranslation(key, replacements) {
                        var tr = translations[key];
                        if (!tr)
                            return;
                        if (replacements) {
                            $(Object.keys(replacements)).each(function (i, replace) {
                                tr = tr.replace("<" + replace + ">", replacements[replace]);
                            });
                        }
                        
                        overrideLog(key + ": " + tr);
                        return tr;
                    }

            function updateTranslations(key, replacements) {
                try {
                    if (replacements) {
                        translations[key] = replacements;
                    }
                } catch (e) {
                    // assume key doesn't exist.
                    overrideLog(e);
                }
                
            }

            function formatDate(date) {
                return date.getDate() + "/" + (date.getMonth() + 1) + "/" + date.getFullYear();
            }
        }(ENV));


        // Elements builder

        function loadDisclaimerInfo() {
            var disclaimerObj = $('.disclosure-list').children().find('p');
            var counter;
            disclaimerObj.each(function(index) {
                counter = index + 1;
                if (counter <= 3) {
                    ENV.Localisation.updateTranslations("disclaimer" + counter, disclaimerObj[index].innerHTML);
                }
            });
        }

        /* Generate tooltip */
        (function () {

            var tooltipInstance;
            var overlay;

            function docGlobUXOnClick(event) {
                if (event.target.id === "optprg-tdr-pop-up-price-tooltip" || $(event.target).parents("#optprg-tdr-pop-up-price-tooltip").length)
                    return;
                event.preventDefault();
                closeTooltip();
            }
            function onResizeOrScrollEvent() {
                closeTooltip();
            }
            function closeTooltip(event) {
                if (event)
                    event.preventDefault();
                if (!tooltipInstance)
                    return;
                overlay.unbind("mousedown", docGlobUXOnClick);
                overlay.unbind("scroll", onResizeOrScrollEvent);
                $(window).unbind("resize", onResizeOrScrollEvent);
                tooltipInstance.remove();
                tooltipInstance = undefined;
            }
            function tooltip(options, close) {
                return DOMBuilder({
                    type: "div",
                    className: "gux-tooltip-overlay",
                    id: "optprg-tdr-pop-up-price-tooltip",
                    props: {
                        tabindex: "0"
                    },
                    callback: function (element) {
                        element.attr("style", "position: absolute; top: " + options.top + "px; left: " + options.left + "px;right: auto; bottom: " + (options.bottom == undefined ? "auto" : options.bottom + "px") + "; z-index: 10001;");
                            },
                    child: [{
                        type: "h5",
                        className: "gux-tooltip-overlay-title",
                        text: options.title
                    }, {
                        type: "span",
                        className: "gux-tooltip-overlay-text",
                        child: [{
                            type: "span",
                            render: options.number ? true : false,
                            text: options.number
                        }, {
                            type: "p",
                            html: options.text
                        }]
                    }, {
                        type: "a",
                        className: "close-icon",
                        handlers: {
                            click: close
                        },
                        props: {
                            tabindex: "0"
                        }
                    }]
                });
            }
            Constructions.openTooltip = function (options) {
                closeTooltip();

                tooltipInstance = tooltip(options, closeTooltip);
                $("#global-ux").append(tooltipInstance);
                if (!overlay)
                    overlay = options.overlay.parent();
                overlay.on("mousedown", docGlobUXOnClick);
                overlay.on("scroll", onResizeOrScrollEvent);
                $(window).on("resize", onResizeOrScrollEvent);
            };
        }());

        /* Component for show easily price - !this file has connection to tooltip definition */

        Constructions.getPrice = function (options) {
            return DOMBuilder({
                type: "span",
                child: [{
                    type: "span",
                    className: "vehicle-attribute-group price-finalPrice-grossRetailWithOTRAndIncentives",
                    child: [{
                        type: "p",
                        className: "optprg-carname",
                        text: options.carName,
                        child: [{
                            type: "span",
                            className: "optprg-subname",
                            //text: options.subName
                            html: options.subName
                        }]
                    },
                        {
                            type: "p",
                            className: "optprg-main-price-label",
                            text: options.recPrice,
                            id: "id-optprg-main-price-label"
                        }, {
                            type: "span",
                            className: "optprg-vehicle-attribute-prefix",
                            text: ENV.Localisation.getTranslation(options.pricePrefixName)
                        }, {
                            type: "span",
                            className: "value optprg-main-price-value",
                            text: options.price
                        }, {
                            type: "span",
                            className: "duty-free",
                            text: options.dutyPrice
                        }, {
                            type: "span",
                            className: "optprg-vehicle-attribute-suffix",
                            text: ENV.Localisation.getTranslation(options.priceSuffixName)
                        }
                    ]
                }, {
                    type: "sup",
                    className: "optprg-sup",
                    render: options.text ? true : false,
                    props: {
                        href: "#"
                    },
                    child: [{
                        type: "a",
                        className: "optprg-a",
                        text: options.number,
                        handlers: {
                            click: function (e) {
                                e.preventDefault();
                                var position = $(this).offset();
                                var size = {
                                    w: $(this).width(),
                                    h: $(this).height()
                                };
                                Constructions.openTooltip({
                                    top: position.top + size.h,
                                    left: position.left + size.w,
                                    title: options.heading,
                                    text: options.text,
                                    number: options.number,
                                    overlay: options.overlay
                                });
                            }
                        }
                    }]
                }]
            });
        };


        // Handlers
        /* Handle close events */

        function initializeCloseHandlers(overlay) {
            function destroy() {
                $(document).unbind("keydown", onKeyPress);
            }
            var handlers = {
                dontShowAgainClose: function (wayOfDestroy, callback) {
                    adobe.target.trackEvent({
                        mbox: MBOXName,
                        params: {
                            release: wayOfDestroy,
                            popup: wayOfDestroy
                        },
                        success: function () {
                            if (callback)
                                callback();
                        },
                        error: function () {
                            if (callback)
                                callback();
                        }
                    });
                    if (callback)
                        setTimeout(function () {
                            callback();
                        }, MBOXFallbackTimeout);
                    destroy();
                },
                showAgainClose: function (wayOfDestroy) {
                    adobe.target.trackEvent({
                        mbox: MBOXName,
                        params: {
                            popup: wayOfDestroy
                        }
                    });
                    destroy();
                }
            };
            function onKeyPress(e) {
                if (e.keyCode == 27) {
                    handlers.dontShowAgainClose("close_escape_keyboard", Popup.setLastClosed());
                }
            }
            $(document).on("keydown", onKeyPress);
            overlay.find("span.overlay-close").on("click", function (e) {
                handlers.dontShowAgainClose("clicked_x", Popup.setLastClosed());
            });
            overlay.parent(".overlay-container").on("click", function (e) {
                if ($(e.target).hasClass("overlay-container"))
                    handlers.showAgainClose("clicked_outside_overlay", Popup.setLastClosed());
            });
            return handlers;
        }

        function updatePopupData(popup_last_closed, popup_display_count) {
            adobe.target.getOffer({
                'mbox': 'global-mbox',
                'params': {
                    'profile.de.popup_last_closed' : popup_last_closed,
                    'profile.de.popup_display_count' : popup_display_count
                },
                'success': function(offer) {
                    adobe.target.applyOffer( {
                        'mbox': 'global-mbox',
                        'offer': offer
                    });
                },
                'error': function(status, error) {
                    console.log('Error', status, error);
                }
            });
        }

        var Popup = {};
        Popup.isPopupOpen = false;
        Popup.showPopupAfter = 900; // IN SECONDS - 900 SECONDS WHICH IS 15 MINUTES
        Popup.openThreshold = 2; // LIMIT THE AMOUNT OF TIMES THE POPUP OPENS
        Popup.currentTimeStamp = Math.floor(Date.now() / 1000);
        Popup.setLastClosed = function() {
            Popup.setKeyValue("popup_last_closed", Math.floor(Date.now() / 1000));
        };
        Popup.determineIfPopupShows = function() {

            var popupCookie = popupData_948;
            var timeBool = false;
            var limitBool = false;

            // ---------------------------------------------
            // DETERMINE IF 15 MINUTE TIME LIMIT HAS EXPIRED
            // ---------------------------------------------
            var timeDifference = Popup.currentTimeStamp - popupCookie.popup_last_closed;

            if(timeDifference > Popup.showPopupAfter) {
                timeBool = true;
            }
            else
            {
                overrideLog("SHOW AFTER FAILED");
                overrideLog("TIME DIFFERENCE: " + timeDifference + "/" + Popup.showPopupAfter);
            }

            // ---------------------------------------------
            // LIMIT OPEN THRESHOLD
            // ---------------------------------------------
            if (popupCookie.popup_display_count <= Popup.openThreshold && timeBool === true) {

                if(popupCookie.popup_last_closed != null) {
                    // INCREASE OPEN COUNTER BY 1
                    Popup.setKeyValue("popup_display_count", ++popupCookie.popup_display_count);
                    Popup.setLastClosed();
                }

                limitBool = true;
            }
            overrideLog("TIMEBOOL : " + timeBool);
            overrideLog("LIMITBOOL: " + limitBool);
            //return true;
            return (timeBool && limitBool) || /targetDebug=948/i.test(window.location.href);
        };
        Popup.setKeyValue = function(key, value) {

            popupData_948[key] = value;

            updatePopupData(popupData_948.popup_last_closed, popupData_948.popup_display_count)
        };

        /* Open TDR Overlay */
        var OverlayHelpers = {};

        (function () {

            var isAlreadyOpenCalled = false;

            OverlayHelpers.openOverlay = function (overlay, onOverlayOpen) {
                if (isAlreadyOpenCalled)
                    return false;

                isAlreadyOpenCalled = true;
                var element = $("<a href=\"" + overlay + "\" style=\"display: none;\" class='test-me'></a>");
                $("body").append(element);

                function waitForOverlayOpen(overlay) {
                    if (!overlay.$overlayContent)
                        return setTimeout(function () {
                            waitForOverlayOpen(overlay);
                        }, 50);
                    onOverlayOpen(overlay);
                }


                /*require(['overlay/component.overlay'],*/

                element.on('click', function (e) {
                    e.preventDefault();
                });

                if(!popupData_948) {

                    updatePopupData(0, 1);
                    Popup.setLastClosed();

                    var overlay = guxOverlay.default.init(element);
                    overrideLog("Trigger Popup");
                    overlay.getOverlayContent('/overlay/content/overlays/target/tdr');
                    waitForOverlayOpen(overlay);
                    Popup.isPopupOpen = true;
                }
                else
                {
                    if(Popup.determineIfPopupShows()) {
                        var overlay = guxOverlay.default.init(element);
                        overrideLog("Trigger Popup");
                        overlay.getOverlayContent('/overlay/content/overlays/target/tdr');
                        waitForOverlayOpen(overlay);
                    }
                }
                element.remove();
            };

            /* Fill overlay with data */
            OverlayHelpers.fillOverlay = function (overlay, data, closeHandlers, limit) {
                ENV.overlayInstance = overlay;
                var overlayContent = overlay.$overlayContent;
                var image = overlayContent.find("img.picture-tag-fallback");

                if (limit >= 100)
                    return false;

                if (!image.length)
                    return setTimeout(function () {
                        OverlayHelpers.fillOverlay(overlay, data, closeHandlers, limit ? limit++ : 1);
                    }, 40);

                locateAllElements(overlayContent, image, data.offerPrice ? true : false);
                fillFinishedBnPOverlay(data, closeHandlers);

            };

            function locateAllElements(overlayContent, image, hasOfferPrice) {
                ENV.elements.overlayContent = overlayContent.addClass("optprg-tdr-pop-up-948-content");

                ENV.elements.image = image.addClass("optprg-tdr-pop-up-image");
                ENV.elements.heading = overlayContent.find("h3").addClass("optprg-tdr-pop-up-heading");
                ENV.elements.offerPrice = overlayContent.find("h4").addClass("optprg-tdr-pop-up-price");
                ENV.elements.retailPrice = overlayContent.find("h5").addClass("optprg-tdr-pop-up-price");
                //test
                ENV.elements.dutyFreePrice = overlayContent.find("h5").addClass("optprg-tdr-pop-up-price");
                ENV.elements.afterPrices = ENV.elements.retailPrice.next("p");
                ENV.elements.secondatyButton = overlayContent.find("a.cta-button.cta-button-secondary");
                ENV.elements.primaryButton = overlayContent.find("a.cta-button.cta-button-primary");
                ENV.elements.horsTaxe = ENV.elements.retailPrice.after(DOMBuilder({
                    type: "p",
                    className: "hors-taxe"
                })).next();

                ENV.elements.priceInformation = ENV.elements.primaryButton.after(DOMBuilder({
                    type: "p",
                    className: "optprg-co2-info"
                })).next();
                ENV.elements.co2Information = ENV.elements.priceInformation.after(DOMBuilder({
                    type: "p",
                    className: "optprg-price-info"
                })).next();
            }

            function fillFinishedBnPOverlay(data, closeHandlers) {
                
                try {
                    loadDisclaimerInfo();
                    var i = 0;
                    ENV.elements.heading.html(ENV.Localisation.getTranslation("heading").replace("<nameplate>", data.carName + ' ' + data.subName));
                    //var priceInfo = ENV.Localisation.getTranslation("priceValidText");
                    ENV.elements.priceInformation.text(ENV.Localisation.getTranslation("priceValidText"));

                    if (!data.offerPrice)
                        ENV.elements.offerPrice.hide();
                    else {
                        ENV.elements.offerPrice.html(Constructions.getPrice({
                            pricePrefixName: "",
                            priceSuffixName: "",
                            carName: data.carName,
                            subName: " " + data.subName,
                            price: "€" + ENV.Localisation.formatMoney(data.offerPrice),
                            //price: "Prix remisé: " + ENV.Localisation.formatMoney(data.offerPrice),
                            //dutyPrice: ENV.Localisation.formatMoney(data.dutyFreePrice),
                            //text: ENV.Localisation.getTranslation("disclaimer1"),
                            //number: "*",
                            recPrice: "Unverbindliche Aktionspreisempfehlung",
                            text: ENV.Localisation.getTranslation("disclaimer1"),
                            number: 1,
                            heading: ENV.Localisation.getTranslation("priceTooltipHeading"),
                            overlay: ENV.elements.overlayContent
                        }));
                    }

                    if (!data.retailPrice)
                        ENV.elements.retailPrice.hide();
                    else {
                        ENV.elements.retailPrice.attr("class", "optprg-retail-price-box " + (data.offerPrice ? "optprg-include-offer" : "optprg-not-include-offer")).html(Constructions.getPrice({
                            pricePrefixName: "",
                            priceSuffixName: "",
                            carName: !data.offerPrice ? data.carName + " " : "",
                            subName: !data.offerPrice ? data.subName : "",
                            //price: (data.retailPrice ? "Prix: " : "") + ENV.Localisation.formatMoney(data.retailPrice),
                            price: "UPE €" + ENV.Localisation.formatMoney(data.retailPrice),
                            //dutyPrice: ENV.Localisation.formatMoney(data.dutyFreePrice),
                            //text: ENV.Localisation.getTranslation("disclaimer2"),
                            //number: "**",
                            recPrice: "",
                            text: ENV.Localisation.getTranslation("disclaimer2"),
                            number: 2,
                            heading: ENV.Localisation.getTranslation("priceTooltipHeading"),
                            overlay: ENV.elements.overlayContent
                        }));
                    }

                    if (data.vehicleType == "CV") {
                        overrideLog('commercial vehicle');
                        $('.optprg-carname').text(storedData_948.carName);
                        $('.optprg-subname').text(storedData_948.subName);
                        $('.hors-taxe').text('Hors Taxe');
                        $('.optprg-main-price-label').text('À partir de');
                        $('.optprg-main-price-label').css("font-size", '1.8rem');
                        $('.hors-taxe').css("font-size", '12px');
                        $('.duty-free').show();
                        $('.value').hide();
                        overrideLog(storedData_948.carName);
                    } else {
                        overrideLog('not commercial vehicle');
                        $('.duty-free').hide();
                        $('.optprg-main-price-label').hide();
                    }

                    overrideLog(data.tdr);
                    overrideLog(data.tdrVehicleCode);

                    ENV.elements.overlayContent.find("source").attr("srcset", data.img);
                    ENV.elements.image.removeAttr("src").attr("src", data.img).attr("alt", data.carName).attr("title", data.carName);
                    ENV.elements.secondatyButton.remove();
                    ENV.elements.primaryButton 
                        .attr("href", data.contextualiseLink)
                        .text(ENV.Localisation.getTranslation("bookTDRButton"))
                        .removeAttr("data-cta-name")
                        .addClass('optprg-primary-button')
                        .on("click", function () {
                            
                            closeHandlers.dontShowAgainClose("clicked_TDR_CTA", function () {

                                adobe.target.trackEvent({
                                    "mbox": MBOXName,
                                    "params": {
                                        "linkClicked": "true"
                                    }
                                });

                                window.targetCampaign = window.targetCampaign || {
                                    page: {
                                        campaignName: "tt:nwp:opt-948:xt:ase:ebpa-popin-3"
                                    }
                                }

                                FordPersonalisation.guxFrameworkDeferred.then(function () {
                                    _satellite.track("impression-xt-popin")
                                });

                                ENV.overlayInstance.hideOverlay();
                            });
                        });

                        ENV.elements.afterPrices.hide();
                        var emissions = data.emissions.co ? getValueUnit(data.emissions.co) : {unit: "", value: ""};
                        var litersToUnit = data.emissions.lToKm ? getValueUnit(data.emissions.lToKm) : {unit: "", value: ""};
                        var hybridInfo = data.emissions.kwToKm ? getValueUnit(data.emissions.kwToKm) : {unit: "", value: ""};
                        

                        litersToUnit.unit = litersToUnit.unit.toLowerCase();
                        litersToUnit.value = litersToUnit.value.replace('.', ',');
                        emissions.value = emissions.value.replace('.', ',');
                        hybridInfo.value = hybridInfo.value == "" ? "" : (
                            hybridInfo.value < 100 ? hybridInfo.value.replace('.', ',') : (
                                ((hybridInfo.value / 10) + "").replace('.', ',')
                            )
                        )
                        
                        var line_fuelConsumption = litersToUnit.value != "" ? ENV.Localisation.getTranslation("fuelConsumption", { 
                                    ltValue: litersToUnit.value,
                                    ltUnit: litersToUnit.unit
                                    }) : "", 
                        line_co2Information = emissions.value != "" ? ENV.Localisation.getTranslation("co2Information", { 
                                    coValue: emissions.value,
                                    coUnit: emissions.unit
                                    }) : "", 
                        line_electricConsumption = hybridInfo.value != "" ? ENV.Localisation.getTranslation("electricConsumption", { 
                                    kwValue: hybridInfo.value
                                    }) : "";

                        if (line_fuelConsumption || line_co2Information || line_electricConsumption) {
                            ENV.elements.co2Information.html(
                                line_fuelConsumption + line_electricConsumption + line_co2Information
                            );

                            var overlayForSup = $('.optprg-tdr-pop-up-948-content');
                            var sups = overlayForSup.find('.supThreeClick');

                            var title = ENV.Localisation.getTranslation('priceTooltipHeading');
                            var text = ENV.Localisation.getTranslation('disclaimer3');

                            for (var i = 0; i < sups.length; i++) {
                                sups[i].onclick = function (e) {
                                    try {
                                        e.preventDefault();
                                        var position = $(this).offset();
                                        var size = {
                                            w: $(this).width(),
                                            h: $(this).height()
                                        };
                                        Constructions.openTooltip({
                                            top: position.top + size.h,
                                            left: position.left + size.w,
                                            bottom: 0,
                                            title: title,
                                            text: text,
                                            number: '3', 
                                            overlay: overlayForSup
                                        });
                                    } catch (E) {
                                        overrideLog(E);
                                    }
                                }     
                            } 
                        } else {
                            overrideLog('hidden emissions');
                            ENV.elements.co2Information.hide();
                        }
                } catch (ex) {
                    overrideLog(ex);
                }
            }
            function getValueUnit(map) {
                if (map.value != undefined)
                    return map;
                var units = Object.keys(map);
                if (!units.length)
                    return null;
                return {
                    unit: map[units[0]].unit,
                    value: map[units[0]].value
                };
            }
        }());
        
        if (!display_948 || !storedData_948.img || !storedData_948.carName)
            return;

        setTimeout(function () {


            OverlayHelpers.openOverlay(ENV.MarketConfiguration.overlay, function (overlay) {

                OverlayHelpers.fillOverlay(overlay, storedData_948, initializeCloseHandlers(overlay.$overlayContent));

                adobe.target.trackEvent({
                    "mbox": MBOXName,
                    "params": {
                        "open": "pop-up-open"
                    }
                });

                window.targetCampaign = window.targetCampaign || {
                    page: {
                        campaignName: "tt:nwp:opt-948:xt:ase:ebpa-popin-3"
                    }
                }

                FordPersonalisation.guxFrameworkDeferred.then(function () {
                    _satellite.track("impression-xt-popin")
                });

            });
        }, ENV.MarketConfiguration.delayBeforeOpenOverlay);
    });
}());

$(window).load(function() {
    var objToHide = document.querySelectorAll('.optprg-carname')[1];
    if (objToHide != undefined) {
        objToHide.style.display = 'none';
    }
});
} } catch (ex) {
        targetErrors.push({ticket: "948", ex});
    }
</script>

<style>

/*

------------------------
|       NOTE           |
------------------------
These aren't currently in the build
adding the styling here so when it is added
we can get the css here.

UPE $48,500 Retail Price
Desktop/Tablet:

font-family: FordAntennaRegular;
font-size: 16px;
font-weight: normal;
font-stretch: normal;
font-style: normal;
line-height:1.63;
letter-spacing: 1px;
color: #4d4d4d;

Disclaimer text below button
Desktop/Tablet:

width: 428px;
height: 63px;
font-family: FordAntennaRegular;
font-size: 12px;
font-weight: normal;
font-stretch: normal;
font-style: normal;
line-height: 1.75;
letter-spacing: 1px;
color: #4d4d4d;

*/
@media only screen and (min-width: 992px) {
#global-ux .overlay-content.optprg-tdr-pop-up-948-content {
    max-width: 1035px;
}

#global-ux .optprg-tdr-pop-up-948-content .splitter-column-wrap > .splitter-column:last-child {
    padding-left: 55px !important;
}

#global-ux .optprg-tdr-pop-up-948-content .image.section {
    width: 393px;
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-tdr-pop-up-heading {
    font-size: 34px;
    font-weight: 300 !important;
    line-height: 1.29 !important;
    letter-spacing: 4px;
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-carname {
    letter-spacing: 3px;
    font-size: 24px !important;
    line-height: 1.42 !important;
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-subname {
    font-size: 24px !important;
}

#global-ux .optprg-tdr-pop-up-948-content #id-optprg-main-price-label {
    display: block !important;
    font-size: 16px;
    line-height: 1.63;
    letter-spacing: 1px;
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-primary-button {
    height: 40px;
    font-size: 14px !important;
    line-height: 0.72;
    letter-spacing: 1px;
    padding: 13px 25px 13px 25px !important;
}
}

#global-ux .optprg-tdr-pop-up-948-content .icon-x, 
#optprg-tdr-pop-up-price-tooltip .close-icon:before {
color: #102b4e !important;
}

#optprg-tdr-pop-up-price-tooltip .gux-tooltip-overlay-title {
font-family: FordAntennaCondLight,AntennaCondExtraLight,Antenna,Arial,Helvetica,sans-serif !important;
margin: 0px;
font-weight: 300;
font-size: 1.125rem;
line-height: 1.39;
letter-spacing: 4px;
color: #4d4d4d;
}

#optprg-tdr-pop-up-price-tooltip .gux-tooltip-overlay-text {
font-family: FordAntennaCondLight,AntennaCondExtraLight,Antenna,Arial,Helvetica,sans-serif !important;
font-weight: 200;
font-size: 18px;
line-height: 1.333;
letter-spacing: .015em;
margin: 0px;
}

#optprg-tdr-pop-up-price-tooltip .gux-tooltip-overlay-text > span {
color: #4d4d4d !important;
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-tdr-pop-up-heading {
text-align: center;
font-family: FordAntennaCondLight,AntennaCondExtraLight,Antenna,Arial,Helvetica,sans-serif !important;
font-stretch: normal;
font-style: normal;
color: #4d4d4d !important;
}

#global-ux #id-optprg-main-price-label {
display: block !important;
font-weight: normal;
font-stretch: normal;
font-style: normal;
color: #4d4d4d;
font-family: FordAntennaCondLight,AntennaCondExtraLight,Antenna,Arial,Helvetica,sans-serif !important;
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-info,
#global-ux .optprg-tdr-pop-up-948-content .optprg-co2-info,
#global-ux .optprg-tdr-pop-up-948-content .optprg-price-info {
font-family: FordAntennaCondLight,AntennaCondExtraLight,Antenna,Arial,Helvetica,sans-serif !important;
font-weight: normal !important;
font-stretch: normal;
font-style: normal;
letter-spacing: 1px;
color: #4d4d4d !important;
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-sup {
font-size: 50%;
top: -1em;
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-a {
text-decoration: unset;
font-family: FordAntennaCondLight,AntennaCondExtraLight,Antenna,Arial,Helvetica,sans-serif !important;
left: auto;
vertical-align: super;
font-size: 0.5625rem;
cursor: pointer;
background: none;
border-width: initial;
border-style: none;
border-color: initial;
border-image: initial;
margin-top: 10px;
color: #4d4d4d;
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-main-price-value {
font-weight: 500;
font-stretch: normal;
font-style: normal;
color: #4d4d4d;
font-family: FordAntennaCondLight,AntennaCondExtraLight,Antenna,Arial,Helvetica,sans-serif !important;

font-size: 24px !important;
line-height: 1.42;
letter-spacing: 3px;
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-primary-button {
border-radius: 20px;
color: #FFF !important;
background-color: #102b4e !important;
border-color: unset !important;
font-weight: normal !important;
font-stretch: normal;
font-style: normal;
font-family: FordAntennaCondLight,AntennaCondExtraLight,Antenna,Arial,Helvetica,sans-serif !important;
margin-bottom: 19px !important;
}
#global-ux .optprg-tdr-pop-up-948-content .optprg-primary-button:hover {
    background-color: rgb(40, 97, 164) !important;
    color: rgb(255, 255, 255) !important;
    box-shadow: rgba(0, 0, 0, 0.1) 0px 10px 10px 0px, rgba(0, 0, 0, 0.1) 0px 20px 20px 0px, rgba(0, 0, 0, 0.15) 0px 30px 30px 0px !important;
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-carname {
font-family: FordAntennaCondLight,AntennaCondExtraLight,Antenna,Arial,Helvetica,sans-serif !important;
font-weight: bold !important;
font-stretch: normal;
font-style: normal;
color: #4d4d4d !important;
}

#global-ux .optprg-tdr-pop-up-948-content p.hors-taxe {
font-size: 12px;
}

#global-ux .optprg-tdr-pop-up-948-content .cta-button.cta-button-primary {
margin-bottom: 2rem;
font-size: .9rem
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-vehicle-attribute-prefix,
#global-ux .optprg-tdr-pop-up-948-content .optprg-vehicle-attribute-suffix {
font-size: 1.8rem;
font-weight: 200
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-info,
#global-ux .optprg-tdr-pop-up-948-content .optprg-co2-info,
#global-ux .optprg-tdr-pop-up-948-content .optprg-price-info {
font-size: 12px !important;
margin: 0 !important;
padding: 0 !important
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-tdr-pop-up-price,
#global-ux .optprg-tdr-pop-up-948-content .optprg-retail-price-box {
font-size: 1.8rem !important;
padding: 0 !important;
margin: 0 !important;
border: none !important
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-tdr-pop-up-price span,
#global-ux .optprg-tdr-pop-up-948-content .optprg-retail-price-box span {
font-size: 1.8rem;
/* font-size: 1.8rem !important */
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-retail-price-box.optprg-include-offer {
margin-top: -12px !important;
font-weight: normal !important;
font-stretch: normal !important;
font-style: normal !important;
color: #4d4d4d !important;

font-size: 16px !important;
line-height: 1.63;
letter-spacing: 1px;
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-retail-price-box.optprg-include-offer span {
font-size: .75rem !important;
font-weight: 300 !important;
letter-spacing: 1px !important;
}

#global-ux .optprg-tdr-pop-up-948-content p.optprg-main-price-label {
font-size: .75rem;
display: block;
padding: 0;
margin: 0
}
/* TABLET */
@media only screen and (min-width:48em) and (max-width:61.9375em) {
#global-ux .optprg-tdr-pop-up-948-content {
    top: 400px !important
}

#global-ux .overlay-content.optprg-tdr-pop-up-948-content {
    max-width: 537px;
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-tdr-pop-up-heading {
    font-size: 24px;
    font-weight: 300 !important;
    line-height: 1.42 !important;
    letter-spacing: 3px;
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-tdr-pop-up-heading br {
    display: none
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-carname {
    letter-spacing: 3px;
    font-size: 24px !important;
    line-height: 1.42 !important;
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-subname {
    font-size: 24px !important;
}

#global-ux .optprg-tdr-pop-up-948-content #id-optprg-main-price-label {
    display: block !important;
    font-size: 16px;
    line-height: 1.63;
    letter-spacing: 1px;
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-primary-button {
    height: 40px;
    font-size: 14px !important;
    line-height: 0.72;
    letter-spacing: 1px;
    padding: 13px 25px 13px 25px !important;
}

#global-ux .optprg-tdr-pop-up-948-content .splitter-column-wrap {
    display: block;
    text-align-last: center;
}

#global-ux .optprg-tdr-pop-up-948-content .splitter-column-wrap .splitter-column.large-6.columns {
    display: block;
    float: none;
    padding: 0;
    width: auto
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-tdr-pop-up-image {
    width: 60%
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-car-name span {
    display: block
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-car-name .optprg-car-name-sub-name {
    margin-top: -6px !important
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-info,
#global-ux .optprg-tdr-pop-up-948-content .optprg-co2-info,
#global-ux .optprg-tdr-pop-up-948-content .optprg-price-info {
    font-size: 12px !important;
    margin: 0 !important;
    padding: 0 !important
}
}

/* MOBILE */

@media only screen and (max-width:30em),
only screen and (min-width:30.0625em) and (max-width:47.9375em) {
#global-ux .optprg-tdr-pop-up-948-content .splitter-column-wrap {
    display: block;
    text-align-last: center;
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-tdr-pop-up-heading {
    font-size: 20px;
    font-weight: 300 !important;
    line-height: 1.5 !important;
    letter-spacing: 3px;
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-primary-button {
    height: 40px;
    font-size: 14px !important;
    line-height: 0.72;
    letter-spacing: 1px;
    padding: 13px 25px 13px 25px !important;
}

#global-ux .optprg-tdr-pop-up-948-content #id-optprg-main-price-label {
    display: block !important;
    font-size: 16px;
    line-height: 1.63;
    letter-spacing: 1px;
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-carname {
    letter-spacing: 3px;
    font-size: 20px !important;
    line-height: 1.5 !important;
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-subname {
    font-size: 20px !important;
}

#global-ux .optprg-tdr-pop-up-948-content .splitter-column-wrap .splitter-column.large-6.columns {
    display: block;
    float: none;
    padding: 0;
    width: auto
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-info,
#global-ux .optprg-tdr-pop-up-948-content .optprg-co2-info,
#global-ux .optprg-tdr-pop-up-948-content .optprg-price-info {
    margin: 0 -15px !important
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-car-name {
    line-height: 2rem !important
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-car-name span {
    display: block
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-car-name .optprg-car-name-sub-name {
    margin-top: -6px !important;
    margin-bottom: 15px !important
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-tdr-pop-up-heading {
    font-weight: 300 !important;
    font-size: 1.5rem;
    line-height: 1.5rem !important;
    margin-top: 16px !important;
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-tdr-pop-up-price {
    margin-top: -10px !important
}

#global-ux .optprg-tdr-pop-up-948-content .optprg-main-price-label {
    margin-bottom: 12px !important
}
}

@media only screen and (max-width:47.9375em) {
#global-ux #optprg-tdr-pop-up-price-tooltip {
    top: 0 !important;
    left: 0 !important;
    height: 100%;
    width: 100%
}
}
</style>