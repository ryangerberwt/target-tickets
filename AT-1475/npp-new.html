<script>
  var $;
  var targetErrors = targetErrors || [];
  var disclosureData;
  var enumerators;
  var disclosuresObj;
  var myEnumerator;
  var existingSups;
  var ENV;
  var overlayContent;

  console.log("OT-1475 - FIESTA/FOCUS NPP");

  var enableLogs = false;
  var _log = console.log;
  var _dir = console.dir;
  console.log = function (logMsg) {
    if (enableLogs) {
      _log.apply(console, arguments);
    }
  };
  console.dir = function (logMsg) {
    if (enableLogs) {
      _dir.apply(console, arguments);
    }
  };

  window.onload = function () {
    let waitForJquery = setInterval(function () {
      console.log("Checking for jQuery");
      if (window.jQuery) {
        // jQuery is loaded
        $ = jQuery;
        clearInterval(waitForJquery);
        // You can place the rest of your script(s) here

        function buildDisclosuresAlternative() {
          var disclosureDataPulled = $(".disclosure-list.large-type")
            .text()
            .split("\n");
          disclosureDataPulled.forEach(function (i) {
            let matched = i.substr(i.indexOf("["), i.indexOf("]") + 1);
            let numericalMatchValue = matched.match(/\d+/);
            if (
              numericalMatchValue !== undefined &&
              numericalMatchValue !== null &&
              numericalMatchValue !== "" &&
              numericalMatchValue.length > 0 &&
              numericalMatchValue.input.length < 5
            ) {
              disclosureData.enumerators.push(numericalMatchValue[0]);
            }
          });
          console.log("# OF DISCLOSURES " + disclosureData.disclosures.length);
          console.log("# OF ENUMS " + disclosureData.enumerators.length);
          console.log(
            "# OF LIST ELEMENTS " + $(".disclosure-list.large-type > li").length
          );

          if (enumerators !== undefined && enumerators.length > 0) {
            myEnumerator = Number(enumerators[enumerators.length - 1]);
            disclosuresObj = JSON.parse(
              localStorage.getItem("3.0_disclaimers")
            );
            for (var y = 0; y < disclosuresObj.length; y++) {
              disclosuresObj[y].suffix_key = (
                myEnumerator +
                (y + 1)
              ).toString();
            }

            for (var x = 0; x < disclosuresObj.length; x++) {
              let counter = Number(x + 1);
              disclosureData.enumerators.push(
                (Number(myEnumerator) + counter).toString()
              );
              disclosureData.disclosures.push({
                name: "disclaimer_" + x,
                text:
                  '<p class="myDisclaimer">' +
                  disclosuresObj[x].disclaimer_content +
                  "</p>",
              });
            }

            $("span[data-disclosures-json]").attr(
              "data-disclosures-json",
              JSON.stringify({
                disclosures: disclosureData.disclosures,
                enumerators: disclosureData.enumerators,
              })
            );

            console.log(
              "# OF DISCLOSURES " + disclosureData.disclosures.length
            );
            console.log("# OF ENUMS " + disclosureData.enumerators.length);
            console.log(
              "# OF LIST ELEMENTS " +
                $(".disclosure-list.large-type > li").length
            );
          }
        }

        function addStr(str, index, stringToAdd) {
          return (
            str.substring(0, index) +
            stringToAdd +
            str.substring(index, str.length)
          );
        }

        function scrapeEnumsFromDOM() {
          //We use this when $('span[data-disclosures-json]').data('disclosures-json').enumerators is null
          let myEnums = [];
          $(".disclosure-list.large-type > li").each(function (i, v) {
            let temp = v.textContent;
            myEnums.push(
              temp
                .substring(
                  v.textContent.indexOf("["),
                  v.textContent.indexOf("]")
                )
                .replace("[", "")
                .replace("]", "")
            );
          });

          return myEnums;
        }

        function cleanUpHtml() {
          $(".hors-taxe + h5 ").remove();
          $(".hors-taxe + p ").remove();
          $(
            ".splitter-column.columns.xlarge-6.large-6>.column-content>.image>.component-content>picture>source"
          ).attr("srcSet", "https:" + storedData_1475.img);
          $(".optprg-tdr-pop-up-image").attr(
            "title",
            storedData_1475.carName + " " + storedData_1475.subName
          );
          $(".optprg-tdr-pop-up-image").attr(
            "alt",
            storedData_1475.carName + " " + storedData_1475.subName
          );
          $('a:contains("Request a Test Drive")').attr(
            "href",
            storedData_1475.contextualiseLink
          );
          $('a:contains("Request a Test Drive")').text(
            "Jetzt Konfiguration fortsetzen"
          );
          let formattedHeading =
            "Sie haben Ihre " +
            storedData_1475.carName +
            " " +
            storedData_1475.subName +
            " Konfiguration noch nicht beendet.";
          $(".optprg-tdr-pop-up-heading").html(formattedHeading);
          $(".optprg-carname-tag > .optprg-carname").text(
            "Der neue " + storedData_1475.carName
          );
          /*$('.optprg-sup').remove();*/

          //The thousand seperator gets added using .toLocaleString()
          let first = Math.round(
            parseFloat($(".value.optprg-main-price-value").eq(0).text())
          ).toLocaleString();

          let second = Math.round(
            parseFloat($(".value.optprg-main-price-value").eq(1).text())
          ).toLocaleString();

          $(".value.optprg-main-price-value").eq(0).text(first);

          $(".value.optprg-main-price-value").eq(1).text(second);

          $(".value.optprg-main-price-value")
            .eq(0)
            .text(
              $(".value.optprg-main-price-value").eq(0).text().replace(",", ".")
            );
          $(".value.optprg-main-price-value")
            .eq(1)
            .text(
              $(".value.optprg-main-price-value").eq(1).text().replace(",", ".")
            );
        }

        function buildDisclosures() {
          if ($("span[data-disclosures-json]") !== undefined) {
            disclosureData = $("span[data-disclosures-json]").data(
              "disclosures-json"
            );
            enumerators = disclosureData.enumerators;
            if (enumerators !== undefined && enumerators.length > 0) {
              console.log("Enums found");
              myEnumerator = Number(enumerators[enumerators.length - 1]);
              disclosuresObj = JSON.parse(
                localStorage.getItem("3.0_disclaimers")
              );
              for (var y = 0; y < disclosuresObj.length; y++) {
                disclosuresObj[y].suffix_key = (
                  myEnumerator +
                  (y + 1)
                ).toString();
              }

              for (var x = 0; x < disclosuresObj.length; x++) {
                let counter = Number(x + 1);
                disclosureData.enumerators.push(
                  (Number(myEnumerator) + counter).toString()
                );
                disclosureData.disclosures.push({
                  name: "disclaimer_" + x,
                  text: "<p>" + disclosuresObj[x].disclaimer_content + "</p>",
                });
              }

              $("span[data-disclosures-json]").attr(
                "data-disclosures-json",
                JSON.stringify({
                  disclosures: disclosureData.disclosures,
                  enumerators: disclosureData.enumerators,
                })
              );
              return true;
            } else {
              return false;
            }
          }
        }

        function addToPopin() {
          existingSups = $(".optprg-sup");

          if (disclosuresObj === undefined || disclosuresObj.length < 1) {
            disclosuresObj = JSON.parse(
              localStorage.getItem("3.0_disclaimers")
            );
          }

          for (var i = 0; i < disclosuresObj.length; i++) {
            if (disclosuresObj[i].disclaimer_content.length > 0) {
              existingSups.eq(i).text(disclosuresObj[i].suffix_key);
              let myId = "opt-gux3-" + (Number(myEnumerator) + 1);
              existingSups.eq(i).attr("id", myId);
              existingSups.eq(i).attr("data-acc-disclosure", "disclaimer_" + i);
              //Init
              accDisclosures.default.initOne($("#" + myId));
            }
          }

          // when tooltip is open, if the target of the click isn't the tooltip nor a descendant of the tooltip
          $(document).mouseup(function (e) {
            var container = $(
              ".optprg-tdr-pop-up-1475-content .acc-tooltip-overlay"
            );

            if (
              !container.is(e.target) &&
              container.has(e.target).length === 0 &&
              container.hasClass("is-visible")
            ) {
              $(
                ".optprg-tdr-pop-up-1475-content .acc-tooltip-overlay a.close-icon"
              ).click();
            }
          });
        }

        function storePopinState(last_closed, display_count) {
          let objs = {
            last_closed_time: last_closed,
            alert_display_count: display_count,
          };
          localStorage.setItem("popinState", JSON.stringify(objs));
          console.log("local storage");
          console.log(JSON.parse(localStorage.getItem("popinState")));
        }

        function compareLastClosed() {
          let popupState = JSON.parse(localStorage.getItem("popinState"));
          let current_timestamp = Math.floor(Date.now() / 1000);
          let last_closed_current = Math.floor(
            popupState.last_closed_time / 1000
          );
          var minuteDifference =
            current_timestamp / 60 - last_closed_current / 60;
          if (minuteDifference >= 15) {
            //It's been 15 days, clear LS
            if (minuteDifference >= 21600) {
              storePopinState(null, Number(0));
              return true;
            }

            if (popupState.alert_display_count < 3) {
              return true;
            } else {
              return false;
            }
          } else {
            return false;
          }
        }

        try {
          // Vehicle Info*
          var storedData_1475 = {
            id: "${profile.id}",
            market: "${profile.market}",
            ticket: "${profile.ticket}",
            carName: "${profile.carName}",
            date: "${profile.date}",
            emissions:
              "${profile.emissions}" == ""
                ? ""
                : JSON.parse("${profile.emissions}".replace(/'/g, '"')),
            img: "${profile.img}",
            retailPrice: "${profile.retailPrice}",
            retailTitle: "${profile.retailTitle}",
            offerPrice: "${profile.offerPrice}",
            offerTitle: "${profile.offerTitle}",
            subName: "${profile.subName}",
            vehicleType: "${profile.vehicleType}",
            contextualiseLink: "${profile.contextualiseLink}",
            vehicleCode: "${profile.tdrVehicleCode}",
          };

          // Popup Data
          var popupData_1475 = {
            popup_last_closed: Number("${profile.at.popup_last_closed}"),
            popup_display_count: Number("${profile.at.popup_display_count}"),
          };

          // Just in case data from a different Market gets through
          // Also checks if a vehicleCode is available, if it doesn't it won't display.
          var display_1475 =
            "AT" == storedData_1475.market &&
            "OT-1475" == storedData_1475.ticket &&
            !storedData_1475.contextualiseLink
              .toLowerCase()
              .includes("undefined");

          if (display_1475) {
            if (storedData_1475.contextualiseLink.indexOf("bodystyle") > 0) {
              storedData_1475.contextualiseLink =
                storedData_1475.contextualiseLink.replace(
                  "bodystyle",
                  "colour"
                );
            } else if (
              storedData_1475.contextualiseLink.indexOf("colour") > 0
            ) {
              storedData_1475.contextualiseLink =
                storedData_1475.contextualiseLink.replace("colour", "interior");
            } else if (
              storedData_1475.contextualiseLink.indexOf("interior") > 0
            ) {
              storedData_1475.contextualiseLink =
                storedData_1475.contextualiseLink.replace("interior", "extras");
            }

            $(document).ready(
              (function () {
                function overrideLog(error) {
                  if (/targetDebug=1475/i.test(window.location.href)) {
                    console.log(error);
                  }

                  targetErrors.push({ ticket: "1475", error });
                }
                /**
                *
                *   DOM builder
                *   (requires jQuery)
                *
                * #def name DOMBuilder
                *
                *   SYNTAX:
                *   jQueryobject DOMbuilder(srcObject);
                *
                *   srcObject = DOMobject || [array of DOMobject] || jQueryObject || [array of jQueryObject] || function (returning srcObject);
                *
                *   DOMobject = {
                *       type: 'div',
                *       id: 'elm-id' || null,
                    render: boolean, // You can decide if element will be rendered
                *       className: 'elm-class' || 'elm-class-1 elm-class-2' || null,
                *       data: { key: key, value: value } || null,
                *       text: 'Text content' || null,
                *       html: 'HTML content' || null,       // if html provided, text is ignored
                *       child: srcObject || null
                *       handlers: { eventID: function, ... } || null,
                *       callback: function($element) || null
                *       } || [ array of DOMobj ]
                *
                */
                function DOMBuilder(obj) {
                  if (!obj) return;
                  if (Object.prototype.toString.call(obj)) {
                    var i,
                      arr = [];
                    for (i = 0; i < obj.length; i++) {
                      obj[i] instanceof $
                        ? arr.push(obj[i])
                        : arr.push(DOMBuilder(obj[i]));
                    }
                    return arr;
                  } else if (obj instanceof $) return obj;
                  else if ($.isFunction(obj)) return DOMBuilder(obj());
                  else {
                    if (!obj.type) return obj.html || obj.text || undefined;
                    if (obj.hasOwnProperty("render") && !obj.render)
                      return undefined;
                    var $e = $("<" + obj.type + ">");
                    if (obj.id) $e.prop("id", obj.id);
                    if (obj.className) $e.addClass(obj.className);
                    if ($.isPlainObject(obj.data) && obj.data.key)
                      $e.data(obj.data.key, obj.data.value);
                    obj.html ? $e.html(obj.html) : $e.text(obj.text || "");
                    if (obj.child) $e.append(DOMBuilder(obj.child));
                    if ($.isPlainObject(obj.handlers)) {
                      for (var evName in obj.handlers)
                        $e.on(evName, obj.handlers[evName]);
                    }
                    if ($.isPlainObject(obj.props)) {
                      for (var propName in obj.props)
                        $e.prop(propName, obj.props[propName]);
                    }
                    if ($.isFunction(obj.callback)) obj.callback($e);
                    return $e;
                  }
                }

                /**
                 * JS VARIANT "Challenger" - Create testdrive popin or similar approach to generate additional testdrive leads
                 */

                $(document).ready(function () {
                  var Constructions = {};
                  ENV = {
                    elements: {},
                    data: {},
                  };

                  // 3.0 Fix
                  setTimeout(function () {
                    if (buildDisclosures() === false) {
                      console.log(
                        "No enums... Calling buildDisclosuresAlternative"
                      );
                      setTimeout(buildDisclosuresAlternative(), 500);
                    }
                  }, 1000);
                  // Configurations
                  /* Market configuration */

                  (function (environment) {
                    environment.MarketConfiguration = {
                      // Define overlay URL
                      overlay: "/overlay/content/overlays/target/acc-tdr",
                      // Define delay in ms before opening overlay
                      delayBeforeOpenOverlay: 10000,

                      // Panel with informations like CO2
                      carDataSelector:
                        "#global-ux .summary-wrapper .vehicle-info-view .vehicle-data .vehicle-data-row",
                      // Selectors to disclaimers in summary page
                      disclaimersSelector:
                        "#global-ux .disclosure-text > ul.disclosure-list",
                      // Selector to offer price (if exists)
                      offerPriceSelector:
                        "#global-ux .vehicle-view-container .vehicle-view-content.left-content .vehicle-view-price .price-promotional-bnp",
                      // Selector to retail price (if exists)
                      retailPriceSelector:
                        "#global-ux .vehicle-view-container .vehicle-view-content.left-content .vehicle-view-price .price-retail-with-otr",

                      // Determine which data will be grabed from summary page
                      summaryPageDataDestinations: [
                        {
                          // Image of car
                          query:
                            "#build-price-configurator > div.app-view > div > div:nth-child(5) > section > div.vehicle-view-container > div.vehicle-view-content.right-content > div > img",
                          prop: "src",
                          key: "img",
                        },
                        {
                          // Find a dealer link
                          query: 'a[data-contextual-link="dealer-locator"]',
                          prop: "href",
                          key: "findDealer",
                        },
                        {
                          // Car nameplate name
                          query:
                            "#build-price-configurator > div.app-view > div > div:nth-child(5) > section > div.vehicle-view-container > div.vehicle-view-content.left-content > h3 > strong",
                          text: true,
                          key: "carName",
                        },
                      ],
                    };
                  })(ENV);

                  var MBOXName = "AT_BP_A_Popin";
                  var MBOXFallbackTimeout = 300;

                  var timer = setInterval(function () {
                    var thisOverlay = document.querySelector(".overlay");
                    if (thisOverlay.classList.contains("is-active")) {
                      overrideLog("run impression id");

                      //run impressions
                      adobe.target.trackEvent({
                        mbox: MBOXName,
                        params: {
                          open: "pop-up-open",
                        },
                      });

                      window.targetCampaign = window.targetCampaign || {
                        page: {
                          campaignName: "tt:nwp:opt-1475:xt:ase:ngc-bpa-bpc",
                        },
                      };
                      _satellite.track("genericTestingImpressionIDWorkaround");

                      clearInterval(timer);
                    }
                  }, 200);

                  /* Define texts - easily move across markets */

                  function returnSupThree() {
                    return "<sup class='supThreeClick'><a style='text-decoration: unset'>3</a></sup>";
                  }

                  $(document).ready(
                    (function (environment) {
                      /*var translations = {
                            heading: "Completa la configurazione della tua prossima <nameplate>?",
                            pricePrefix: "€",
                            priceSuffix: "",
                            retailpricePrefix: "",
                            retailpriceSuffix: "",
                            dutyFree: "",
                            priceValidText: "",
                            mainPriceLabel: "",
                            mainPriceLabelNoOfferPrice: "",
                            retailPriceLabel: "",
                            priceTooltipHeading: "Belangrijke informatie",
                            bookTDRButton: "Clicca qui",
                            buttonURL: storedData_1475.contextualiseLink,
                            retailDisclaimer: "",
                            retailKey: "",
                            retailLabel: "",
                            offerDisclaimer: "",
                            offerKey: "",
                            offerLabel: "",
                        };*/

                      var translations = {
                        heading:
                          "Sie haben Ihre <nameplate> Konfiguration noch nicht beendet.",
                        pricePrefix: "€",
                        priceSuffix: "",
                        dutyFree: "",
                        mainPriceLabel: "",
                        mainPriceLabelNoOfferPrice: "",

                        priceTooltipHeading: "Rechtliche Hinweise",
                        bookTDRButton: "Jetzt Konfiguration fortsetzen",

                        retailDisclaimer: "",
                        retailKey: "",
                        retailLabel: "",

                        offerDisclaimer: "",
                        offerKey: "",
                        offerLabel: "",
                      };

                      environment.Localisation = {
                        formatDate: formatDate,
                        formatMoney: function (amount) {
                          return Number(Number(amount).toFixed(0))
                            .toLocaleString()
                            .replace(/\,/gm, ".");
                        },
                        getTranslation: getTranslation,
                        updateTranslations: updateTranslations,
                        requiredLabelsExist: requiredLabelsExist,
                      };

                      function isNull(obj) {
                        return obj == undefined || obj == null || obj == "";
                      }

                      function requiredLabelsExist() {
                        if (!isNull(storedData_1475.offerPrice))
                          if (isNull(getTranslation("offerLabel")))
                            return false;

                        if (!isNull(storedData_1475.retailPrice))
                          if (isNull(getTranslation("retailLabel")))
                            return false;

                        return true;
                      }

                      function getTranslation(key, replacements) {
                        var tr = translations[key];
                        if (!tr) return;
                        if (replacements) {
                          $(Object.keys(replacements)).each(function (
                            i,
                            replace
                          ) {
                            tr = tr.replace(
                              "<" + replace + ">",
                              replacements[replace]
                            );
                          });
                        }

                        overrideLog(key + ": " + tr);
                        return tr;
                      }

                      function updateTranslations(key, replacements) {
                        try {
                          if (replacements) {
                            translations[key] = replacements;
                          }
                        } catch (e) {
                          // assume key doesn't exist.
                          overrideLog(e);
                        }
                      }

                      function formatDate(date) {
                        return (
                          date.getDate() +
                          "/" +
                          (date.getMonth() + 1) +
                          "/" +
                          date.getFullYear()
                        );
                      }
                    })(ENV)
                  );

                  var StorageHandler = {};
                  StorageHandler.cookie = "opt-gux-it"; // opt-gux-MARKET ~ for countries with multiple locales, name it MARKET_LANG ~ Always lower case.
                  StorageHandler.getData = function () {
                    var current = JSON.parse(
                      localStorage.getItem(StorageHandler.cookie)
                    );
                    if (current == null) return [];
                    else return current;
                  };
                  StorageHandler.saveData = function (key, data) {
                    var current = StorageHandler.getData();

                    var exists = StorageHandler.getSpecificData(key);

                    if (exists.length > 0) {
                      for (var i = 0; i < current.length; i++) {
                        if (current[i].key == key) {
                          current[i].data = data;
                        }
                      }
                    } else {
                      current.push({ key, data });
                    }
                    localStorage.setItem(
                      StorageHandler.cookie,
                      JSON.stringify(current)
                    );
                  };
                  StorageHandler.getSpecificData = function (key) {
                    var current = StorageHandler.getData();
                    return current.filter(function (each) {
                      return each.key == key;
                    });
                  };

                  // Elements builder
                  function loadInfo() {
                    ENV.Localisation.updateTranslations(
                      "offerLabel",
                      storedData_1475.offerTitle
                    );
                    ENV.Localisation.updateTranslations(
                      "retailLabel",
                      storedData_1475.retailTitle
                    );
                    var key = "disclaimers_1475_" + storedData_1475.id;

                    var data = StorageHandler.getSpecificData(key);

                    if (data.length == 0) {
                      return;
                    }

                    var disclaimerObj = data[0].data;

                    for (var i = 0; i < disclaimerObj.length; i++) {
                      if (disclaimerObj[i].type == "Retail") {
                        ENV.Localisation.updateTranslations(
                          "retailDisclaimer",
                          disclaimerObj[i].content
                        );
                        ENV.Localisation.updateTranslations(
                          "retailKey",
                          disclaimerObj[i].symbol
                        );
                      } else if (disclaimerObj[i].type == "Offer") {
                        ENV.Localisation.updateTranslations(
                          "offerDisclaimer",
                          disclaimerObj[i].content
                        );
                        ENV.Localisation.updateTranslations(
                          "offerKey",
                          disclaimerObj[i].symbol
                        );
                      }
                    }
                  }
                  loadInfo();

                  /* Generate tooltip */
                  $(document).ready(
                    (function () {
                      var tooltipInstance;
                      var overlay;

                      function docGlobUXOnClick(event) {
                        if (
                          event.target.id ===
                            "optprg-tdr-pop-up-price-tooltip" ||
                          $(event.target).parents(
                            "#optprg-tdr-pop-up-price-tooltip"
                          ).length
                        )
                          return;
                        event.preventDefault();
                        closeTooltip();
                      }
                      function onResizeOrScrollEvent() {
                        closeTooltip();
                      }
                      function closeTooltip(event) {
                        if (event) event.preventDefault();
                        if (!tooltipInstance) return;
                        overlay.unbind("mousedown", docGlobUXOnClick);
                        overlay.unbind("scroll", onResizeOrScrollEvent);
                        $(window).unbind("resize", onResizeOrScrollEvent);
                        tooltipInstance.remove();
                        tooltipInstance = undefined;
                      }
                      function tooltip(options, close) {
                        return DOMBuilder({
                          type: "div",
                          className: "gux-tooltip-overlay",
                          id: "optprg-tdr-pop-up-price-tooltip",
                          props: {
                            tabindex: "0",
                          },
                          callback: function (element) {
                            element.attr(
                              "style",
                              "position: absolute; top: " +
                                options.top +
                                "px; left: " +
                                options.left +
                                "px;right: auto; bottom: " +
                                (options.bottom == undefined
                                  ? "auto"
                                  : options.bottom + "px") +
                                "; z-index: 10001;"
                            );
                          },
                          child: [
                            {
                              type: "h5",
                              className: "gux-tooltip-overlay-title",
                              text: options.title,
                            },
                            {
                              type: "span",
                              className: "gux-tooltip-overlay-text",
                              child: [
                                {
                                  type: "span",
                                  render: options.number ? true : false,
                                  text: options.number,
                                },
                                {
                                  type: "p",
                                  html: options.text,
                                },
                              ],
                            },
                            {
                              type: "a",
                              className: "close-icon",
                              handlers: {
                                click: close,
                              },
                              props: {
                                tabindex: "0",
                              },
                            },
                          ],
                        });
                      }
                      Constructions.openTooltip = function (options) {
                        closeTooltip();

                        tooltipInstance = tooltip(options, closeTooltip);
                        document
                          .querySelector("#global-ux")
                          .append(tooltipInstance);
                        if (!overlay) overlay = options.overlay.parent();
                        overlay.on("mousedown", docGlobUXOnClick);
                        overlay.on("scroll", onResizeOrScrollEvent);
                        $(window).on("resize", onResizeOrScrollEvent);
                      };
                    })()
                  );

                  /* Component for show easily price - !this file has connection to tooltip definition */

                  Constructions.getPrice = function (options) {
                    return DOMBuilder({
                      type: "span",
                      child: [
                        {
                          type: "span",
                          className:
                            "vehicle-attribute-group price-finalPrice-grossRetailWithOTRAndIncentives",
                          child: [
                            {
                              type: "p",
                              className: "optprg-carname",
                              text: options.carName,
                              child: [
                                {
                                  type: "span",
                                  className: "optprg-subname",
                                  html: options.subName,
                                },
                              ],
                            },
                            {
                              type: "p",
                              className: "optprg-main-price-label",
                              text: options.recPrice,
                              id: "id-optprg-main-price-label",
                            },
                            {
                              type: "span",
                              className: "optprg-vehicle-attribute-prefix",
                              text: ENV.Localisation.getTranslation(
                                options.pricePrefixName
                              ),
                            },
                            {
                              type: "span",
                              className: "value optprg-main-price-value",
                              text: options.price,
                            },
                            {
                              type: "span",
                              className: "duty-free",
                              text: options.dutyPrice,
                            },
                            {
                              type: "span",
                              className: "optprg-vehicle-attribute-suffix",
                              text: ENV.Localisation.getTranslation(
                                options.priceSuffixName
                              ),
                            },
                          ],
                        },
                        {
                          type: "sup",
                          className: "optprg-sup",
                          render: options.text ? true : false,
                          props: {
                            href: "#",
                          },
                          child: [
                            {
                              type: "a",
                              className: "optprg-a",
                              text: options.number,
                              handlers: {
                                click: function (e) {
                                  e.preventDefault();
                                  var position = document
                                    .querySelector(this)
                                    .offset();
                                  var size = {
                                    w: document.querySelector(this).width(),
                                    h: document.querySelector(this).height(),
                                  };
                                  Constructions.openTooltip({
                                    top: position.top + size.h,
                                    left: position.left + size.w,
                                    title: options.heading,
                                    text: options.text,
                                    number: options.number,
                                    overlay: options.overlay,
                                  });
                                },
                              },
                            },
                          ],
                        },
                      ],
                    });
                  };

                  // Handlers
                  /* Handle close events */

                  function initializeCloseHandlers(overlay) {
                    function destroy() {
                      $(document).unbind("keydown", onKeyPress);
                      destroyOverlay();
                    }
                    function destroyOverlay() {
                      var content = $(".optprg-tdr-pop-up-1475-content"); // Replace 1041 to match the ticket you're on.
                      if (content.length > 0) {
                        var contentParent = content[0].parentElement;
                        if (
                          contentParent !== undefined &&
                          contentParent.classList.value.includes(
                            "overlay-container"
                          )
                        ) {
                          //popupData_1475.popup_display_count ++;
                          contentParent.remove();
                        }
                      }
                    }
                    var handlers = {
                      dontShowAgainClose: function (
                        wayOfDestroy,
                        callback,
                        mbox
                      ) {
                        adobe.target.trackEvent({
                          mbox: mbox,
                          params: {
                            release: wayOfDestroy,
                            popup: wayOfDestroy,
                          },
                          success: function () {
                            if (callback) callback();
                          },
                          error: function () {
                            if (callback) callback();
                          },
                        });
                        if (callback)
                          setTimeout(function () {
                            callback();
                          }, MBOXFallbackTimeout);
                        destroy();
                      },
                      showAgainClose: function (wayOfDestroy, mbox) {
                        adobe.target.trackEvent({
                          mbox: mbox,
                          params: {
                            popup: wayOfDestroy,
                          },
                        });
                        destroy();
                      },
                    };
                    function onKeyPress(e) {
                      if (e.keyCode == 27) {
                        let cPopinState = JSON.parse(
                          localStorage.getItem("popinState")
                        );
                        let num = Number(cPopinState.alert_display_count + 1);
                        handlers.dontShowAgainClose(
                          "close_escape_keyboard",
                          storePopinState(Math.floor(Date.now()), num),
                          "AT_1475_close_cta_ctr"
                        );
                      }
                    }

                    document.addEventListener("keydown", function (e) {
                      onKeyPress(e);
                    });

                    var divOverlayClose = document.querySelector(
                      "span.overlay-close-button"
                    );
                    divOverlayClose.addEventListener("click", function (e) {
                      let cPopinState = JSON.parse(
                        localStorage.getItem("popinState")
                      );
                      let num = Number(cPopinState.alert_display_count + 1);
                      handlers.dontShowAgainClose(
                        "clicked_x",
                        storePopinState(Math.floor(Date.now()), num),
                        "AT_1475_close_cta_ctr"
                      );
                    });
                    var divOverlayParent =
                      document.querySelector(".overlay").parentNode;

                    var elementWrapper = document.querySelector(
                      ".overlay-content-wrapper"
                    );

                    divOverlayParent.addEventListener("click", function (e) {
                      if (
                        event.target.classList.contains(
                          ".overlay-content-wrapper"
                        )
                      ) {
                        handlers.showAgainClose(
                          "clicked_outside_overlay",
                          storePopinState(Math.floor(Date.now()), num),
                          "AT_1475_close_cta_ctr"
                        );
                      }
                    });
                    return handlers;
                  }

                  function updatePopupData(
                    popup_last_closed,
                    popup_display_count
                  ) {
                    adobe.target.getOffer({
                      mbox: "global-mbox",
                      params: {
                        "profile.at.popup_last_closed": popup_last_closed,
                        "profile.at.popup_display_count": popup_display_count,
                      },
                      success: function (offer) {
                        adobe.target.applyOffer({
                          mbox: "global-mbox",
                          offer: offer,
                        });
                      },
                      error: function (status, error) {
                        console.log("Error", status, error);
                      },
                    });
                  }

                  var Popup = {};

                  Popup.determineIfPopupShows = function () {
                    if (!ENV.Localisation.requiredLabelsExist()) {
                      overrideLog("Price labels, not populated");
                      return false;
                    }

                    if (compareLastClosed() === false) {
                      return false;
                    }

                    return (
                      compareLastClosed() ||
                      /targetDebug=1475/i.test(window.location.href)
                    );
                  };
                  Popup.setKeyValue = function (key, value) {
                    popupData_1475[key] = value;

                    updatePopupData(
                      popupData_1475.popup_last_closed,
                      popupData_1475.popup_display_count
                    );
                  };

                  /* Open TDR Overlay */
                  var OverlayHelpers = {};

                  $(document).ready(
                    (function () {
                      if (
                        localStorage.getItem("popinState") === undefined ||
                        localStorage.getItem("popinState") === null
                      ) {
                        storePopinState(null, Number(0));
                      }
                      OverlayHelpers.openOverlay = function (
                        overlay,
                        onOverlayOpen
                      ) {
                        if (compareLastClosed() === false) {
                          return false;
                        }

                        // create overlay anchor tag
                        var overlayLink = document.createElement("a");
                        overlayLink.className =
                          "link-overlay popin-1475 acc-pd-overlay initialized-overlay initialized-bevLinkOverlay";
                        ("link-overlay popin-1475 acc-pd-overlay initialized-overlay initialized-bevLinkOverlay");
                        overlayLink.href =
                          "/overlay/content/overlays/target/acc-tdr";
                        overlayLink.setAttribute("role", "button");
                        overlayLink.innerText = "POPIN OT-1475";
                        document.body.appendChild(overlayLink);

                        var element = document.querySelector(".popin-1475");

                        function waitForOverlayOpen(overlay) {
                          if (!accOverlay.default.$overlay[0])
                            return setTimeout(function () {
                              waitForOverlayOpen(overlay);
                            }, 50);
                          onOverlayOpen(overlay);
                        }

                        element.addEventListener("click", function (e) {
                          e.preventDefault();
                        });

                        var overlay = accOverlay.default.init(element);

                        element.click();

                        if (!popupData_1475) {
                          overrideLog("1. popupData_1475");
                          updatePopupData(0, 1);

                          var overlay = accOverlay.default.init(element);
                          overrideLog("Trigger Popup");
                          let popupState = JSON.parse(
                            localStorage.getItem("popinState")
                          );
                          //overlay.getOverlayContent('/overlay/content/overlays/target/tdr');
                          waitForOverlayOpen(overlay);
                          Popup.isPopupOpen = true;
                        } else {
                          if (Popup.determineIfPopupShows()) {
                            console.log(
                              popupData_1475.popup_display_count,
                              popupData_1475.popup_last_closed
                            );
                            let popupState = JSON.parse(
                              localStorage.getItem("popinState")
                            );
                            var overlay = accOverlay.default.init(element);
                            overrideLog("Trigger Popup");
                            //overlay.getOverlayContent('/overlay/content/overlays/target/tdr');
                            waitForOverlayOpen(overlay);

                            overrideLog("2. here");
                          }
                        }

                        //storePopinState(Math.floor(Date.now()), (Number(popupState.alert_display_count) + 1));
                        element.remove();
                      };

                      /* Fill overlay with data */
                      OverlayHelpers.fillOverlay = function (
                        overlay,
                        data,
                        closeHandlers,
                        limit
                      ) {
                        ENV.overlayInstance = accOverlay.default.instances[7];
                        overlayContent = accOverlay.default.$overlay[0];
                        overlayContent.id = "global-ux";

                        var image = overlayContent.querySelector(
                          ".overlay .splitter .image img"
                        );

                        if (limit >= 100) return false;

                        if (
                          $(
                            ".splitter-column.columns.xlarge-6.large-6>.column-content>.image>.component-content>picture>img"
                          ).length === 0
                        )
                          return setTimeout(function () {
                            OverlayHelpers.fillOverlay(
                              overlay,
                              data,
                              closeHandlers,
                              limit ? limit++ : 1
                            );
                          }, 40);
                        let interValWait = setInterval(function () {
                          if (
                            $("#global-ux") !== undefined &&
                            $("#global-ux").length > 0
                          ) {
                            $("#global-ux").css("opacity", 0);
                            locateAllElements(
                              overlayContent,
                              image,
                              data.offerPrice ? true : false
                            );
                            fillFinishedBnPOverlay(data, closeHandlers);
                            $("#global-ux").css("opacity", 1);
                            clearInterval(interValWait);
                          }
                        }, 250);
                      };

                      function locateAllElements(
                        overlayContent,
                        image,
                        hasOfferPrice
                      ) {
                        try {
                          setTimeout(function () {
                            ENV.elements.overlayContentWrapper =
                              overlayContent.querySelector(
                                ".overlay-content-wrapper"
                              );
                            ENV.elements.overlayContentWrapper.classList.add(
                              "optprg-tdr-pop-up-1475-content"
                            );

                            if (image !== undefined && image !== null) {
                              ENV.elements.image = image.classList.add(
                                "optprg-tdr-pop-up-image"
                              );
                            }

                            let wait = setInterval(function () {
                              if (
                                overlayContent.querySelector("h3") !==
                                  undefined &&
                                overlayContent.querySelector("h3") !== null
                              ) {
                                console.log("found the heading");
                                ENV.elements.heading = overlayContent
                                  .querySelector("h3")
                                  .classList.add("optprg-tdr-pop-up-heading");
                                clearInterval(wait);
                              }
                            }, 100);

                            let waitAgain = setInterval(function () {
                              if (
                                overlayContent.querySelector("h4") !==
                                  undefined &&
                                overlayContent.querySelector("h4") !== null
                              ) {
                                console.log("found the offer price");
                                ENV.elements.offerPrice = overlayContent
                                  .querySelector("h4")
                                  .classList.add("optprg-tdr-pop-up-price");
                                clearInterval(waitAgain);
                              }
                            }, 100);

                            var elemPrice,
                              clonedPrice,
                              vehicleAttrContainer,
                              nextVehicleAttrContainer;

                            let waitYetAgain = setInterval(function () {
                              console.log("waitYetAgain...");
                              if (
                                overlayContent.querySelector(
                                  ".optprg-tdr-pop-up-price"
                                ) !== undefined &&
                                overlayContent.querySelector(
                                  ".optprg-tdr-pop-up-price"
                                ) !== null
                              ) {
                                console.log("found the elem price");
                                ENV.elements.offerPrice = overlayContent
                                  .querySelector("h4")
                                  .classList.add("optprg-tdr-pop-up-price");

                                elemPrice = overlayContent.querySelector(
                                  ".optprg-tdr-pop-up-price"
                                );
                                elemPrice.innerHTML = "";
                                clonedPrice = elemPrice.cloneNode(true);
                                ENV.elements.retailPrice =
                                  elemPrice.parentNode.insertBefore(
                                    clonedPrice,
                                    elemPrice.nextSibling
                                  );
                                ENV.elements.retailPrice.outerHTML =
                                  ENV.elements.retailPrice.outerHTML.replaceAll(
                                    "h4",
                                    "h5"
                                  );

                                ENV.elements.retailPrice =
                                  overlayContent.querySelector("h5");
                                vehicleAttrContainer =
                                  document.createElement("span");
                                // Add class and HTML content
                                vehicleAttrContainer.className =
                                  "vehicle-attribute-group";
                                vehicleAttrContainer.innerHTML =
                                  '<span class="vehicle-attribute-group"> <span class="vehicle-attribute-group price-finalPrice-grossRetailWithOTRAndIncentives"> ' +
                                  '<h4 class="optprg-carname-tag"><span class = "optprg-carname"> ' +
                                  storedData_1475.carName +
                                  ' </span> <span class="optprg-subname"> ' +
                                  storedData_1475.subName +
                                  " </span> </h4>" +
                                  '<h4 class="optprg-main-price-label" id="id-optprg-main-price-label"> ' +
                                  storedData_1475.offerTitle +
                                  "  </h4>" +
                                  '<h4 class="optprg-offer-price"> <span class="optprg-vehicle-attribute-prefix"> € </span>' +
                                  '<span class="value optprg-main-price-value"> ' +
                                  storedData_1475.offerPrice +
                                  " </span>" +
                                  '<span class="duty-free"> </span>' +
                                  '<span class="optprg-vehicle-attribute-suffix"> </span>' +
                                  '<sup class="optprg-sup" href="#"><a class="optprg-a">' +
                                  ENV.Localisation.getTranslation("offerKey") +
                                  "</a></sup></h4></span></span>";

                                elemPrice.appendChild(
                                  vehicleAttrContainer,
                                  elemPrice
                                );

                                nextVehicleAttrContainer =
                                  document.createElement("span");

                                nextVehicleAttrContainer.className =
                                  "optprg-retail-price-box";
                                nextVehicleAttrContainer.innerHTML =
                                  '<span class="vehicle-attribute-group price-finalPrice-grossRetailWithOTRAndIncentives"></span>' +
                                  '<h4 class="optprg-carname"><span class="optprg-subname"></span></h4>' +
                                  '<h4 class="optprg-main-price-label" id="id-optprg-main-price-label"> ' +
                                  storedData_1475.retailTitle +
                                  "</h4>" +
                                  '<h4 class="optprg-retail-price"> <span class="optprg-vehicle-attribute-prefix"> € </span>' +
                                  '<span class="value optprg-main-price-value"> ' +
                                  storedData_1475.retailPrice +
                                  " </span>" +
                                  '<span class="duty-free"> </span>' +
                                  '<span class="optprg-vehicle-attribute-suffix"> </span>' +
                                  '<sup class="optprg-sup" href="#"><a class="optprg-a">' +
                                  ENV.Localisation.getTranslation("retailKey") +
                                  "</a></sup></h4>";

                                ENV.elements.retailPrice.appendChild(
                                  nextVehicleAttrContainer,
                                  ENV.elements.retailPrice
                                );
                                ENV.elements.secondaryButton =
                                  overlayContent.querySelector(
                                    "a.cta-button.cta-button-secondary"
                                  );
                                ENV.elements.primaryButton =
                                  overlayContent.querySelector(
                                    "a.cta-button.cta-button-primary"
                                  );
                                ENV.elements.horsTaxe =
                                  document.createElement("p");
                                ENV.elements.horsTaxe.className = "hors-taxe";
                                ENV.elements.retailPrice.parentNode.insertBefore(
                                  ENV.elements.horsTaxe,
                                  ENV.elements.retailPrice.nextSibling
                                );
                                clearInterval(waitYetAgain);
                              }
                            }, 100);
                          }, 350);
                        } catch (e) {}
                      }

                      function fillFinishedBnPOverlay(data, closeHandlers) {
                        try {
                          var i = 0;
                          ENV.elements.heading = document.querySelector(
                            "h3.optprg-tdr-pop-up-heading"
                          );
                          ENV.elements.priceInformation =
                            document.querySelector("p.optprg-price-info");
                          ENV.elements.offerPrice = $(
                            ".vehicle-attribute-group h4.optprg-tdr-pop-up-price"
                          );
                          ENV.elements.pricePrefix = document.querySelector(
                            ".vehicle-attribute-group span.optprg-vehicle-attribute-prefix"
                          );
                          ENV.elements.carName = document.querySelector(
                            ".vehicle-attribute-group .optprg-carname"
                          );
                          ENV.elements.subName = document.querySelector(
                            ".vehicle-attribute-group span.optprg-subname"
                          );
                          ENV.elements.price = document.querySelector(
                            ".vehicle-attribute-group .optprg-main-price-value"
                          );
                          ENV.elements.recPrice = document.querySelector(
                            ".vehicle-attribute-group .optprg-main-price-label"
                          );
                          ENV.elements.horsTaxe =
                            document.querySelector(".hors-taxe");
                          ENV.elements.dutyFree =
                            document.querySelector(".duty-free");

                          // RETAIL*
                          ENV.elements.retailPricePrefix =
                            document.querySelector(
                              ".optprg-retail-price-box span.optprg-vehicle-attribute-prefix"
                            );
                          ENV.elements.retailpriceSuffixName =
                            document.querySelector(
                              ".optprg-retail-price-box .optprg-vehicle-attribute-suffix"
                            );
                          ENV.elements.retailcarName = document.querySelector(
                            ".optprg-retail-price-box .optprg-carname"
                          );
                          ENV.elements.retailsubName = document.querySelector(
                            ".optprg-retail-price-box .optprg-subname"
                          );
                          ENV.elements.retailPrice = $(
                            ".optprg-retail-price-box"
                          );
                          ENV.elements.retailPriceValue =
                            document.querySelector(
                              ".optprg-retail-price-box .optprg-main-price-value"
                            );
                          ENV.elements.retailPriceLabel =
                            document.querySelector(
                              ".optprg-retail-price-box  .optprg-main-price-label"
                            );
                          ENV.elements.heading.innerHTML =
                            ENV.Localisation.getTranslation("heading").replace(
                              "<nameplate>",
                              data.carName + " " + data.subName
                            );

                          var imgNodelist = document.querySelectorAll(
                            "div.image.section > div.component-content source"
                          );
                          var i = 0;
                          for (; i < imgNodelist.length; i++) {
                            imgNodelist[i].remove();
                          }
                          ENV.elements.popinVehicleImage =
                            document.querySelector(".optprg-tdr-pop-up-image");
                          ENV.elements.popinVehicleImage.src =
                            "https:" + storedData_1475.img;

                          ENV.elements.primaryButton.href =
                            ENV.Localisation.getTranslation("buttonURL") +
                            data.vehicleCode;
                          ENV.elements.primaryButton.innerHTML =
                            ENV.Localisation.getTranslation("bookTDRButton");
                          ENV.elements.primaryButton.removeAttribute(
                            "data-cta-name"
                          );
                          ENV.elements.primaryButton.classList.add(
                            "optprg-primary-button"
                          );
                          ENV.elements.primaryButton.addEventListener(
                            "click",
                            function (e) {
                              closeHandlers.dontShowAgainClose(
                                "clicked_TDR_CTA",
                                function () {
                                  adobe.target.trackEvent({
                                    mbox: MBOXName,
                                    params: {
                                      linkClicked: "true",
                                    },
                                  });

                                  window.addEventListener("load", function () {
                                    _satellite.track("impression-xt-popin");
                                  });

                                  ENV.overlayInstance.hideOverlay();
                                },
                                "AT_1475_main_cta_ctr"
                              );
                            }
                          );

                          // MachE being the only vehicle with a visible price.

                          if (!storedData_1475.retailPrice) {
                            overrideLog("Hide Retail Price");
                            ENV.elements.retailPrice.hide();
                          } else {
                            overrideLog("2. Got here");

                            ENV.elements.retailPricePrefix.innerHTML =
                              ENV.Localisation.getTranslation("pricePrefix");
                            ENV.elements.retailpriceSuffixName.innerHTML =
                              ENV.Localisation.getTranslation("priceSuffix");
                            ENV.elements.retailcarName.innerHTML =
                              !data.offerPrice ? data.carName + " " : "";
                            ENV.elements.retailsubName.innerHTML =
                              !data.offerPrice ? data.subName : "";
                            ENV.elements.retailPriceValue.innerHTML =
                              ENV.Localisation.formatMoney(data.retailPrice);
                            ENV.elements.retailPriceLabel.innerHTML =
                              ENV.Localisation.getTranslation("retailLabel");
                          }

                          if (!storedData_1475.offerPrice) {
                            overrideLog("Hide Offer Price");
                            ENV.elements.offerPrice.hide();
                          } else {
                            overrideLog("1. Got here");

                            ENV.elements.priceInformation.innerHTML =
                              ENV.Localisation.getTranslation("priceValidText");
                            ENV.elements.pricePrefix.innerHTML =
                              ENV.Localisation.getTranslation("pricePrefix");
                            ENV.elements.carName.innerHTML = data.carName;
                            ENV.elements.subName.innerHTML = data.subName;
                            ENV.elements.price.innerHTML =
                              ENV.Localisation.formatMoney(data.offerPrice);
                            ENV.elements.recPrice.innerHTML =
                              ENV.Localisation.getTranslation("offerLabel");
                          }

                          overrideLog(data.tdr);
                          overrideLog(data.tdrVehicleCode);
                          var emissions = data.emissions.co
                            ? getValueUnit(data.emissions.co)
                            : { unit: "", value: "" };
                          var litersToUnit = data.emissions.lToKm
                            ? getValueUnit(data.emissions.lToKm)
                            : { unit: "", value: "" };
                          var hybridInfo = data.emissions.kwToKm
                            ? getValueUnit(data.emissions.kwToKm)
                            : { unit: "", value: "" };

                          overrideLog(emissions);
                          overrideLog(litersToUnit);
                          overrideLog(hybridInfo);

                          litersToUnit.unit = litersToUnit.unit.toLowerCase();
                          litersToUnit.value = litersToUnit.value.replace(
                            ".",
                            ","
                          );
                          emissions.value = emissions.value.replace(".", ",");
                          hybridInfo.value =
                            hybridInfo.value == ""
                              ? ""
                              : hybridInfo.value < 100
                              ? hybridInfo.value.replace(".", ",")
                              : (hybridInfo.value / 10 + "").replace(".", ",");

                          var line_fuelConsumption =
                              litersToUnit.value != ""
                                ? ENV.Localisation.getTranslation(
                                    "fuelConsumption",
                                    {
                                      ltValue: litersToUnit.value,
                                      ltUnit: litersToUnit.unit,
                                    }
                                  )
                                : "",
                            line_co2Information =
                              emissions.value != ""
                                ? ENV.Localisation.getTranslation(
                                    "co2Information",
                                    {
                                      coValue: emissions.value,
                                      coUnit: emissions.unit,
                                    }
                                  )
                                : "",
                            line_electricConsumption =
                              hybridInfo.value != ""
                                ? ENV.Localisation.getTranslation(
                                    "electricConsumption",
                                    {
                                      kwValue: hybridInfo.value,
                                    }
                                  )
                                : "";

                          if (
                            line_fuelConsumption ||
                            line_co2Information ||
                            line_electricConsumption
                          ) {
                            ENV.elements.co2Information.html(
                              line_fuelConsumption +
                                line_electricConsumption +
                                line_co2Information
                            );

                            var overlayForSup = document.querySelector(
                              ".optprg-tdr-pop-up-1475-content"
                            );
                            var sups =
                              overlayForSup.querySelectorAll(".supThreeClick");

                            var title = ENV.Localisation.getTranslation(
                              "priceTooltipHeading"
                            );
                            var text =
                              ENV.Localisation.getTranslation("disclaimer3");

                            for (
                              var i = 0;
                              i <
                              document.getElementsByClassName("supThreeClick")
                                .length;
                              i++
                            ) {
                              sups[i].onclick = function (e) {
                                try {
                                  e.preventDefault();
                                  var position = document
                                    .querySelector(this)
                                    .offset();
                                  var size = {
                                    w: document.querySelector(this).width(),
                                    h: document.querySelector(this).height(),
                                  };
                                  Constructions.openTooltip({
                                    top: position.top + size.h,
                                    left: position.left + size.w,
                                    bottom: 0,
                                    title: title,
                                    text: text,
                                    number: "3",
                                    overlay: overlayForSup,
                                  });
                                } catch (E) {
                                  overrideLog(E);
                                }
                              };
                            }
                          } else {
                            overrideLog("hidden emissions");
                            ENV.elements.co2Information.hide();
                          }
                        } catch (ex) {
                          overrideLog(ex);
                        }
                      }
                      function getValueUnit(map) {
                        if (map.value != undefined) return map;
                        var units = Object.keys(map);
                        if (!units.length) return null;
                        return {
                          unit: map[units[0]].unit,
                          value: map[units[0]].value,
                        };
                      }
                    })()
                  );

                  if (
                    !display_1475 ||
                    !storedData_1475.img ||
                    !storedData_1475.carName ||
                    !storedData_1475.contextualiseLink
                  )
                    return;

                  var Popupdetection = {};
                  Popupdetection.getCookie = function (name) {
                    var cookie = " " + document.cookie;
                    var search = " " + name + "=";
                    var setStr = null;
                    var offset = 0;
                    var end = 0;
                    if (cookie.length > 0) {
                      offset = cookie.indexOf(search);
                      if (offset != -1) {
                        offset += search.length;
                        end = cookie.indexOf(";", offset);
                        if (end == -1) {
                          end = cookie.length;
                        }
                        setStr = unescape(cookie.substring(offset, end));
                      }
                    }
                    return setStr;
                  };

                  function containsSophus() {
                    if (
                      typeof s3_creativeDisplayed === "undefined" &&
                      (typeof s3_creativeDisplayed !== "object" ||
                        !s3_creativeDisplayed)
                    )
                      return false;
                    if (s3_creativeDisplayed) return true;
                    return false;
                  }

                  function getCookieNameContains(nameIncludes) {
                    var allCookies = document.cookie;
                    if (allCookies.length > 0) {
                      var cookieArray = allCookies.split(";");
                      for (var i = 0; i < cookieArray.length; i++) {
                        var name = cookieArray[i].split("=")[0];
                        if (name.includes(nameIncludes)) return true;
                      }
                    }
                    return false;
                  }

                  function blockPopup() {
                    if (
                      getCookieNameContains("IPE") ||
                      getCookieNameContains("IPE_M_") ||
                      containsSophus() ||
                      compareLastClosed() === false
                    ) {
                      overrideLog("blocked");
                      return true;
                    }
                    if (window.location.href.indexOf("?td=1475") > 0) {
                      return false;
                    }
                    return false;
                  }

                  if (blockPopup()) return;

                  setTimeout(function () {
                    if (!blockPopup()) {
                      OverlayHelpers.openOverlay(
                        ENV.MarketConfiguration.overlay,
                        function (overlay) {
                          OverlayHelpers.fillOverlay(
                            overlay,
                            storedData_1475,
                            initializeCloseHandlers(
                              accOverlay.default.$overlay[0]
                            )
                          );

                          adobe.target.trackEvent({
                            mbox: MBOXName,
                            params: {
                              open: "pop-up-open",
                            },
                          });

                          window.targetCampaign = window.targetCampaign || {
                            page: {
                              campaignName:
                                "tt:nwp:opt-1475:xt:ase:ngc-bpa-bpc",
                            },
                          };

                          window.addEventListener("load", function () {
                            _satellite.track("impression-xt-popin");
                          });
                        }
                      );
                    }
                  }, ENV.MarketConfiguration.delayBeforeOpenOverlay);

                  let myInterval = setInterval(function () {
                    if (
                      $(".optprg-sup") !== undefined &&
                      $(".optprg-sup").length == 2
                    ) {
                      cleanUpHtml();
                      clearInterval(myInterval);
                      addToPopin();
                    }
                  }, 500);
                });
              })()
            );

            window.addEventListener("load", function () {
              var objToHide = document.querySelectorAll(".optprg-carname")[1];
              if (objToHide != undefined) {
                objToHide.style.display = "none";
              }
            });
          }
        } catch (ex) {
          console.info("new solution required");
          targetErrors.push({ ticket: "1475", error });
        }
      }
    }, 500);
  };
</script>

<style>
  .overlay-content-wrapper.optprg-tdr-pop-up-1475-content {
    height: auto !important;
    left: 50% !important;
    position: absolute !important;
    top: 50% !important;
    transform: translate(-50%, -50%) !important;
    width: 65% !important;
  }

  .optprg-tdr-pop-up-1475-content h3.optprg-tdr-pop-up-heading {
    text-align: center;
    letter-spacing: 4px;
    font-size: 24px;
    font-weight: 300 !important;
    line-height: 1.29 !important;
  }

  .optprg-tdr-pop-up-1475-content span.optprg-carname,
  .optprg-tdr-pop-up-1475-content span.optprg-subname {
    font-weight: bold;
  }

  .optprg-tdr-pop-up-1475-content h4.optprg-offer-price,
  .optprg-tdr-pop-up-1475-content h4.optprg-retail-price {
    display: flex;
  }

  .optprg-tdr-pop-up-1475-content .optprg-offer-price sup,
  .optprg-tdr-pop-up-1475-content .optprg-retail-price sup {
    position: relative;
    left: 2px;
    top: 10px;
  }

  /* Desktop  */
  @media (min-width: 801px) {
    .optprg-tdr-pop-up-1475-content .overlay-inner .overlay-content .box {
      padding: 0 !important;
    }

    .optprg-tdr-pop-up-1475-content .acc-tooltip-overlay {
      position: absolute !important;
      left: 50% !important;
      z-index: 10000 !important;
    }
  }

  @media screen and (min-width: 48em) {
    .optprg-tdr-pop-up-1475-content .acc-tooltip-overlay,
    #global-ux .acc-tooltip-overlay,
    .optprg-tdr-pop-up-1475-content .acc-tooltip-overlay {
      max-width: 46%;
      height: auto;
      max-height: 320px;
      overflow-y: scroll;
    }
  }

  @media screen and (min-width: 48em) {
    .optprg-tdr-pop-up-1475-content .acc-tooltip-overlay .tooltip-overlay-inner,
    .optprg-tdr-pop-up-1475-content .acc-tooltip-overlay .tooltip-overlay-inner,
    .optprg-tdr-pop-up-1475-content
      .acc-tooltip-overlay
      .tooltip-overlay-inner {
      max-height: 100% !important;
    }
  }

  .optprg-tdr-pop-up-1475-content
    > .acc-tooltip-overlay[id][data-position="none"],
  .optprg-tdr-pop-up-1475-content
    > .gux-tooltip-overlay[id][data-position="none"],
  body
    > .optprg-tdr-pop-up-1475-content.acc-tooltip-overlay[id][data-position="none"],
  body
    > .optprg-tdr-pop-up-1475-content.gux-tooltip-overlay[id][data-position="none"] {
    transform: translate(0%, -40%);
    position: fixed !important;
  }

  /* Tablet and Mobile */
  @media (max-width: 768px) {
    .overlay-content-wrapper.optprg-tdr-pop-up-1475-content {
      height: 100% !important;
      margin: auto !important;
      overflow-y: auto !important;
      padding: 25px !important;
      width: 100% !important;
    }
  }

  /*
    h4.optprg-carname-tag {
        font-family: FordAntennaCondLight, AntennaCondExtraLight, Antenna, Arial, Helvetica, sans-serif !important;
        letter-spacing: 3px !important;
        font-size: 18px !important;
        line-height: 1.42 !important;
        margin-bottom: 10px !important;
        font-stretch: normal !important;
        font-style: normal !important;
        color: #4d4d4d !important;
    }

    #id-optprg-main-price-label {
        font-weight: 500 !important;
        font-stretch: normal !important;
        font-style: normal !important;
        color: #4d4d4d !important;
        font-family: FordAntennaCondLight, AntennaCondExtraLight, Antenna, Arial, Helvetica, sans-serif !important;
        font-size: 24px !important;
        line-height: 1.42 !important;
        letter-spacing: 3px !important;
    }

    @media (min-width:1024px) {
        #gux3>.box.box-white-background.box-regular-top-padding.box-regular-bottom-padding.box-regular-left-right-padding {
            padding: 70px 8.3% 70px 8.3% !important
        }


        .heading-normal {
            text-align: center !important;
            font-family: FordAntennaCondLight, AntennaCondExtraLight, Antenna, Arial, Helvetica, sans-serif !important;
            font-stretch: normal !important;
            font-style: normal !important;
            color: #4d4d4d !important;
            font-size: 24px !important;
            font-weight: 300 !important;
            line-height: 1.29 !important;
            letter-spacing: 4px !important;
        }

        .car-name {
            font-family: FordAntennaCondLight, AntennaCondExtraLight, Antenna, Arial, Helvetica, sans-serif !important;
            font-weight: bold !important;
            font-stretch: normal !important;;
            font-style: normal !important;;
            color: #4d4d4d !important;
            letter-spacing: 3px;
            font-size: 18px !important;
            line-height: 1.42 !important;
        }

        .copy-price-value {
            letter-spacing: 1px !important;
            font-weight: 500 !important;
            font-stretch: normal !important;
            font-style: normal !important;
            color: #4d4d4d !important;
            font-family: FordAntennaCondLight, AntennaCondExtraLight, Antenna, Arial, Helvetica, sans-serif !important;
            font-size: 24px !important;
            line-height: 1.42 !important;
        }

        .copy-price-labels {
            display: block !important;
            font-size: 16px !important;
            letter-spacing: 1px !important;
            margin-top: -12px !important;
            font-weight: normal !important;
            font-stretch: normal !important;
            font-style: normal !important;
            color: #4d4d4d !important;
            font-family: FordAntennaCondLight, AntennaCondExtraLight, Antenna, Arial, Helvetica, sans-serif !important;
        }


        .splitter-column.columns.xlarge-6.large-6 {
            padding: 15px !important;

        }

    }*/
</style>
